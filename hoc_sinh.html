<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitty AI - Final Fix</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- 1. GIAO DI·ªÜN ƒê·∫∏P (GI·ªÆ NGUY√äN) --- */
        :root {
            --primary: #ff9f43;
            --bg-color: #fff0e6;
            --chat-ai: #ffffff;
            --chat-text: #333;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --modal-bg: rgba(255,255,255,0.95);
        }

        body.dark-mode {
            --primary: #e67e22;
            --bg-color: #2d3436;
            --chat-ai: #636e72;
            --chat-text: #dfe6e9;
            --shadow: 0 10px 30px rgba(0,0,0,0.3);
            --modal-bg: rgba(45, 52, 54, 0.95);
        }

        body.theme-sad { --primary: #74b9ff; --bg-color: #f1f7ff; }
        body.dark-mode.theme-sad { --bg-color: #1e272e; --primary: #0984e3; }
        body.theme-stress { --primary: #ff7675; --bg-color: #fff0f0; }
        body.theme-happy { --primary: #00b894; --bg-color: #e6fffa; }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; transition: all 0.3s ease; }
        body { background-color: var(--bg-color); color: var(--chat-text); display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }

        /* KHUNG APP */
        .app-container { 
            width: 100%; max-width: 450px; height: 95vh; 
            background: rgba(255,255,255,0.75); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 30px; 
            box-shadow: var(--shadow); 
            display: flex; flex-direction: column; position: relative; 
            overflow: hidden; border: 2px solid var(--primary); 
        }
        body.dark-mode .app-container { background: rgba(45, 52, 54, 0.8); border-color: #555; }

        /* HEADER */
        .header { 
            padding: 20px; background: var(--primary); color: white; 
            display: flex; align-items: center; justify-content: space-between; 
            z-index: 20; box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
        }
        .avatar-wrapper { display: flex; align-items: center; gap: 10px; }
        .kitty-icon { font-size: 1.8rem; }
        .theme-btn { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }

        /* CHAT AREA */
        .chat-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        .msg { max-width: 80%; padding: 12px 18px; border-radius: 20px; font-size: 0.95rem; line-height: 1.5; word-wrap: break-word; animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .msg.ai { align-self: flex-start; background: var(--chat-ai); color: var(--chat-text); border-bottom-left-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .msg.user { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 5px; box-shadow: 0 5px 15px rgba(var(--primary), 0.4); }

        /* TYPING */
        .typing { display: none; align-self: flex-start; background: var(--chat-ai); padding: 10px 15px; border-radius: 20px; margin-left: 10px; width: fit-content; margin-bottom: 10px;}
        .dot { display: inline-block; width: 6px; height: 6px; background: #bbb; border-radius: 50%; margin: 0 2px; animation: bounce 1.4s infinite; }
        .dot:nth-child(2) { animation-delay: 0.2s; } .dot:nth-child(3) { animation-delay: 0.4s; }

        /* INPUT AREA */
        .input-area { 
            padding: 15px; background: var(--chat-ai); 
            border-top: 1px solid rgba(0,0,0,0.05); 
            display: flex; gap: 10px; align-items: center; 
        }
        input { 
            flex: 1; padding: 12px 15px; border: none; 
            border-radius: 25px; outline: none; background: rgba(0,0,0,0.05); 
            color: var(--chat-text); font-size: 1rem;
        }
        .icon-btn { 
            width: 45px; height: 45px; border-radius: 50%; border: none; 
            background: var(--primary); color: white; cursor: pointer; 
            font-size: 1.1rem; display: flex; justify-content: center; align-items: center;
            transition: 0.2s;
        }
        .icon-btn:hover { transform: scale(1.1); }
        .mic-btn { background: #2ecc71; }
        .mic-btn.listening { animation: pulse 1.5s infinite; background: #e74c3c; }

        /* TOOLS BAR */
        .tools-bar { 
            display: grid; grid-template-columns: repeat(3, 1fr); 
            background: var(--chat-ai); padding-bottom: 10px; padding-top: 5px;
        }
        .tool-btn { 
            background: none; border: none; cursor: pointer; 
            display: flex; flex-direction: column; align-items: center; gap: 5px; 
            color: #888; font-size: 0.75rem; transition: 0.2s;
        }
        .tool-btn:hover { color: var(--primary); transform: translateY(-3px); }
        .tool-btn i { font-size: 1.3rem; background: rgba(0,0,0,0.05); padding: 10px; border-radius: 15px; }

        /* RESET BUTTON */
        .float-reset { 
            position: absolute; bottom: 160px; right: 20px; 
            width: 50px; height: 50px; 
            background: white; border: 2px solid var(--primary); 
            border-radius: 50%; display: flex; justify-content: center; align-items: center; 
            color: var(--primary); box-shadow: 0 5px 20px rgba(0,0,0,0.2); 
            cursor: pointer; z-index: 50; transition: 0.3s; 
        }
        .float-reset:hover { transform: rotate(180deg) scale(1.1); }

        /* MODALS */
        .modal { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--modal-bg); z-index: 100; 
            display: none; flex-direction: column; padding: 25px; 
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .modal.active { display: flex; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: bold; color: var(--primary); font-size: 1.3rem; }
        .close-btn { background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--chat-text); line-height: 1; padding: 0 10px; }

        .therapy-item { 
            background: rgba(0,0,0,0.03); padding: 15px; border-radius: 15px; 
            margin-bottom: 15px; border-left: 5px solid var(--primary); 
            display: flex; justify-content: space-between; align-items: center;
        }
        .therapy-btn-mini { background: var(--primary); color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; font-weight: bold; }

        .map-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 20px; }
        .dot-map { width: 40px; height: 40px; border-radius: 50%; background: #eee; display: flex; justify-content: center; align-items: center; font-size: 0.7rem; color: white; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* OVERLAYS */
        #resetOverlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(135deg, #a8e6cf, #dcedc1); z-index: 300; 
            display: none; flex-direction: column; justify-content: center; align-items: center; 
            color: #2d3436; animation: fadeIn 0.5s;
        }
        .reset-circle { width: 180px; height: 180px; border: 8px solid white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 3rem; font-weight: bold; color: white; animation: breathe 8s infinite; }

        #sosOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #ff4d4d; z-index: 999; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; padding: 20px; animation: pulseRed 2s infinite; }
        .sos-btn { background: white; color: #ff4d4d; border: none; padding: 15px 30px; border-radius: 30px; font-weight: bold; font-size: 1.2rem; margin-top: 20px; cursor: pointer; text-decoration: none; display: inline-block;}

        /* ANIMATIONS */
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
        @keyframes breathe { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulseRed { 0% { background: #ff4d4d; } 50% { background: #ff3333; } 100% { background: #ff4d4d; } }
    </style>
</head>
<body>

    <div class="app-container">
        
        <div class="header">
            <div class="avatar-wrapper">
                <i class="fas fa-cat kitty-icon"></i>
                <div style="margin-left: 10px;">
                    <div style="font-weight: bold; font-size: 1.1rem;">Kitty AI</div>
                    <div style="font-size: 0.75rem; opacity: 0.9;" id="statusText">Tr·ª£ l√Ω c·∫£m x√∫c</div>
                </div>
            </div>
            <button class="theme-btn" onclick="toggleDarkMode()"><i class="fas fa-moon"></i></button>
        </div>

        <div class="chat-area" id="chatBox"></div>
        
        <div class="typing" id="typingIndicator">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
        
        <div class="float-reset" onclick="activateReset()" title="Reset T√¢m Tr√≠">
            <i class="fas fa-redo"></i>
        </div>

        <div class="input-area">
            <input type="text" id="userInput" placeholder="Nh·∫Øn tin..." autocomplete="off">
            <button class="icon-btn mic-btn" id="voiceBtn" onclick="startDictation()"><i class="fas fa-microphone"></i></button>
            <button class="icon-btn" onclick="handleChat()"><i class="fas fa-paper-plane"></i></button>
        </div>

        <div class="tools-bar">
            <button class="tool-btn" onclick="openModal('statsModal')">
                <i class="fas fa-chart-line" style="color:#0984e3"></i> Th·ªëng k√™
            </button>
            <button class="tool-btn" onclick="openModal('therapyModal')">
                <i class="fas fa-heartbeat" style="color:#e84393"></i> Tr·ªã li·ªáu
            </button>
            <button class="tool-btn" onclick="openModal('mapModal')">
                <i class="fas fa-users" style="color:#00b894"></i> L·ªõp h·ªçc
            </button>
        </div>

        <div class="modal" id="statsModal">
            <div class="modal-header">
                <span>üìà Bi·ªÉu ƒê·ªì C·∫£m X√∫c</span>
                <button class="close-btn" onclick="closeModal('statsModal')">√ó</button>
            </div>
            <div style="height: 300px; width: 100%;">
                <canvas id="emotionChart"></canvas>
            </div>
            <p style="text-align:center; color:#888; font-size:0.8rem; margin-top:10px;">D·ªØ li·ªáu 20 tin nh·∫Øn g·∫ßn nh·∫•t</p>
        </div>

        <div class="modal" id="mapModal">
            <div class="modal-header">
                <span>üó∫Ô∏è B·∫£n ƒê·ªì L·ªõp</span>
                <button class="close-btn" onclick="closeModal('mapModal')">√ó</button>
            </div>
            <div class="map-grid" id="classMapGrid"></div>
        </div>

        <div class="modal" id="therapyModal">
            <div class="modal-header">
                <span>üíä G√≥c Tr·ªã Li·ªáu</span>
                <button class="close-btn" onclick="closeModal('therapyModal')">√ó</button>
            </div>
            <div class="therapy-item">
                <span><i class="fas fa-wind"></i> H√≠t th·ªü 4-7-8</span>
                <button class="therapy-btn-mini" onclick="startExercise('breath')">T·∫≠p</button>
            </div>
            <div class="therapy-item">
                <span><i class="fas fa-child"></i> Th∆∞ gi√£n c·ªï vai</span>
                <button class="therapy-btn-mini" onclick="startExercise('stretch')">T·∫≠p</button>
            </div>
            <div class="therapy-item">
                <span><i class="fas fa-hand-holding"></i> K·ªπ thu·∫≠t 5-4-3-2-1</span>
                <button class="therapy-btn-mini" onclick="startExercise('grounding')">T·∫≠p</button>
            </div>
        </div>

        <div id="resetOverlay">
            <h2>Th∆∞ gi√£n s√¢u...</h2>
            <div class="reset-circle" id="resetCount">30</div>
            <p>Ti·∫øng ·ªìn tr·∫Øng (White Noise)</p>
            <button onclick="closeReset()" style="margin-top:30px; padding:10px 30px; border-radius:20px; border:none; font-weight:bold; cursor:pointer;">ƒê√£ ·ªïn h∆°n</button>
        </div>

        <div id="sosOverlay">
            <div style="font-size:4rem">‚ö†Ô∏è</div>
            <h2>C·∫¢NH B√ÅO</h2>
            <p>Ch√∫ng m√¨nh nh·∫≠n th·∫•y b·∫°n ƒëang tr·∫£i qua c·∫£m x√∫c ti√™u c·ª±c. H√£y li√™n h·ªá ng∆∞·ªùi th√¢n ngay!</p>
            <a href="tel:111" class="sos-btn">G·ªçi 111</a>
            <button onclick="document.getElementById('sosOverlay').style.display='none'" style="background:none; border:1px solid white; color:white; padding:10px; margin-top:20px; border-radius:10px; cursor:pointer;">ƒê√≥ng</button>
        </div>

    </div>

    <script>
        // ============================================================
        // ‚ö†Ô∏è D√ÅN API KEY GROQ C·ª¶A B·∫†N V√ÄO D√ÇY ‚ö†Ô∏è
        const API_KEY = "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"; 
        // ============================================================

        const LINK_VUI = "https://open.spotify.com/embed/playlist/4lPLZ0npUWzSpeg0BPOVdp?si=UjYu0QMTTiudxfcW1kPKxg";
        const LINK_LOFI = "https://open.spotify.com/embed/playlist/0jSMk9A4W6wnFUkfrBuRaG?si=-W7y9Rc6Sxq_k6MhiTugRw";
        const SOS_WORDS = ["t·ª± t·ª≠", "mu·ªën ch·∫øt", "t·ª± s√°t", "r·∫°ch tay", "nh·∫£y l·∫ßu", "u·ªëng thu·ªëc ng·ªß", "k·∫øt th√∫c cu·ªôc ƒë·ªùi"];

        let messages = []; 
        let history = JSON.parse(localStorage.getItem('emotionHistory')) || []; 
        let audioCtx, whiteNoiseSource;
        let myChart = null; 

        // --- H√ÄM KH·ªûI CH·∫†Y (GLOBAL SCOPE) ---
        window.onload = function() {
            renderClassMap();
            checkDarkMode();
            
            // AI Ch√†o ngay l·∫≠p t·ª©c
            const greeting = "Ch√†o b·∫°n! B·∫°n c·∫ßn t∆∞ v·∫•n g√¨ h√¥m nay? üò∫";
            addMessage(greeting, 'ai');
            document.getElementById('statusText').innerText = "Groq AI Online ‚ö°";
            
            // C·∫•u h√¨nh n√£o AI
            const systemPrompt = `
                B·∫°n l√† Kitty AI, chuy√™n gia t√¢m l√Ω h·ªçc ƒë∆∞·ªùng.
                QUY T·∫ÆC C·ªêT L√ïI:
                1. N·∫øu user c√≥ v·∫ª bu·ªìn/stress -> An ·ªßi v√† h·ªèi: "C·∫≠u c√≥ mu·ªën nghe nh·∫°c Lofi kh√¥ng?".
                2. N·∫øu user ƒê·ªíNG √ù nghe nh·∫°c (ok, c√≥, nghe, uhm...) -> CH·ªà TR·∫¢ L·ªúI CH√çNH X√ÅC C·ª§M T·ª™: "PLAY_SPOTIFY_NOW". KH√îNG ƒê∆Ø·ª¢C GI·∫¢I TH√çCH G√å TH√äM.
                3. C√°c tr∆∞·ªùng h·ª£p kh√°c: T∆∞ v·∫•n t√¢m l√Ω ng·∫Øn g·ªçn, ·∫•m √°p.
            `;

            messages.push({ role: "system", content: systemPrompt });
            messages.push({ role: "assistant", content: greeting });

            if(!API_KEY || API_KEY.includes("D√ÅN_M√É_KEY")) {
                setTimeout(() => alert("‚ö†Ô∏è C·∫¢NH B√ÅO: Ch∆∞a nh·∫≠p API Key Groq! Web s·∫Ω kh√¥ng tr·∫£ l·ªùi ƒë∆∞·ª£c."), 1000);
            }
        };

        // --- H√ÄM X·ª¨ L√ù CHAT ---
        async function handleChat() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if(!text) return;

            // SOS Check
            if(SOS_WORDS.some(kw => text.toLowerCase().includes(kw))) {
                document.getElementById('sosOverlay').style.display='flex';
                input.value=''; return;
            }

            // G·ª≠i tin nh·∫Øn
            addMessage(text, 'user');
            input.value = '';
            
            // Hi·ªáu ·ª©ng typing
            const typing = document.getElementById('typingIndicator');
            typing.style.display = 'block';
            document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;

            messages.push({ role: "user", content: text });

            try {
                const aiText = await callGroqAPI(messages);
                typing.style.display = 'none';
                
                messages.push({ role: "assistant", content: aiText });
                processResponse(aiText, text);

            } catch (error) {
                typing.style.display = 'none';
                addMessage("‚ö†Ô∏è L·ªói: " + error.message, 'ai');
            }
        }

        // --- G·ªåI API ---
        async function callGroqAPI(msgs) {
            const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                body: JSON.stringify({ model: "llama-3.3-70b-versatile", messages: msgs, temperature: 0.7 })
            });
            if (!response.ok) throw new Error((await response.json()).error.message);
            return (await response.json()).choices[0].message.content;
        }

        // --- X·ª¨ L√ù PH·∫¢N H·ªíI (NH·∫†C) ---
        function processResponse(text, userText) {
            if (text.includes("PLAY_SPOTIFY_NOW")) {
                addMessage("Oki! Nh·∫°c l√™n ngay ƒë√¢y. üé∂", 'ai');
                
                const t = userText.toLowerCase();
                let link = LINK_LOFI; 
                if (t.includes("vui") || t.includes("tuy·ªát") || t.includes("h·∫°nh ph√∫c")) link = LINK_VUI;
                
                addMessage(`<iframe style="border-radius:12px; margin-top:10px;" src="${link}" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>`, 'ai');
            } else {
                addMessage(text.replace(/\*\*/g, ''), 'ai');
            }
            
            // Bi·ªÉu ƒë·ªì
            const t = userText.toLowerCase();
            let score = 5;
            if(t.includes('bu·ªìn')||t.includes('kh√≥c')) { changeTheme('sad'); score=2; }
            else if(t.includes('vui')||t.includes('tuy·ªát')) { changeTheme('happy'); score=10; }
            else if(t.includes('cƒÉng')||t.includes('lo')) { changeTheme('stress'); score=1; }
            saveHistory(userText, score);
        }

        // --- C√ÅC H√ÄM PH·ª§ TR·ª¢ ---
        function addMessage(html, type) {
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerHTML = html;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // --- H√ÄM M·ªû/ƒê√ìNG MODAL (ƒê√É S·ª¨A L·ªñI) ---
        function openModal(id) {
            // ƒê√≥ng c√°c modal kh√°c tr∆∞·ªõc
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
            // M·ªü modal n√†y
            const m = document.getElementById(id);
            if(m) {
                m.classList.add('active');
                if(id === 'statsModal') renderChart();
            }
        }

        function closeModal(id) {
            const m = document.getElementById(id);
            if(m) m.classList.remove('active');
        }

        // --- T√çNH NƒÇNG TR·ªä LI·ªÜU (ƒê√É S·ª¨A L·ªñI HI·ªÜN CH·ªÆ "ai") ---
        function startExercise(type) {
            closeModal('therapyModal'); // ƒê√≥ng modal tr∆∞·ªõc
            
            let content = "";
            if (type === 'breath') {
                content = `<b>üå¨Ô∏è B√†i t·∫≠p H√≠t th·ªü 4-7-8:</b><br>1. H√≠t v√†o m≈©i (4s)<br>2. N√≠n th·ªü (7s)<br>3. Th·ªü ra mi·ªáng (8s)<br><i>L·∫∑p l·∫°i 4 l·∫ßn nh√©!</i>`;
            } else if (type === 'stretch') {
                content = `<b>üôÜ Th∆∞ gi√£n C·ªï & Vai:</b><br>1. Nghi√™ng ƒë·∫ßu sang tr√°i (gi·ªØ 10s)<br>2. Nghi√™ng sang ph·∫£i (gi·ªØ 10s)<br>3. Xoay vai ra sau 5 l·∫ßn.`;
            } else if (type === 'grounding') {
                content = `<b>üëÅÔ∏è K·ªπ thu·∫≠t 5-4-3-2-1:</b><br>üëÄ T√¨m 5 v·∫≠t b·∫°n th·∫•y<br>‚úã T√¨m 4 v·∫≠t b·∫°n ch·∫°m ƒë∆∞·ª£c<br>üëÇ T√¨m 3 √¢m thanh b·∫°n nghe<br>üëÉ T√¨m 2 m√πi h∆∞∆°ng<br>üëÖ T√¨m 1 v·ªã b·∫°n c·∫£m nh·∫≠n`;
            }

            addMessage(content, 'ai');
        }

        function changeTheme(e) { document.body.className = ''; if(e) document.body.classList.add(`theme-${e}`); checkDarkMode(); }
        
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('kitty_darkMode', isDark);
            document.querySelector('.theme-btn i').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        }
        function checkDarkMode() {
            if(localStorage.getItem('kitty_darkMode') === 'true') { 
                document.body.classList.add('dark-mode');
                document.querySelector('.theme-btn i').className = 'fas fa-sun';
            }
        }

        function startDictation() {
            if (window.hasOwnProperty('webkitSpeechRecognition')) {
                var recognition = new webkitSpeechRecognition();
                recognition.lang = "vi-VN";
                const btn = document.getElementById('voiceBtn');
                btn.classList.add('listening');
                recognition.start();
                recognition.onresult = function(e) { document.getElementById('userInput').value = e.results[0][0].transcript; recognition.stop(); btn.classList.remove('listening'); };
                recognition.onerror = function(e) { recognition.stop(); btn.classList.remove('listening'); alert("Kh√¥ng nghe r√µ."); };
            } else { alert("D√πng Chrome ƒë·ªÉ n√≥i nh√©."); }
        }

        function saveHistory(text, score) {
            history.push({ time: new Date().toLocaleTimeString(), text: text, score: score });
            if(history.length > 20) history.shift();
            localStorage.setItem('emotionHistory', JSON.stringify(history));
        }

        function renderChart() {
            const ctx = document.getElementById('emotionChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: history.map(h => h.time),
                    datasets: [{
                        label: 'C·∫£m x√∫c (1-10)',
                        data: history.map(h => h.score),
                        borderColor: '#ff9f43',
                        backgroundColor: 'rgba(255, 159, 67, 0.2)',
                        tension: 0.4, fill: true
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 10 } } }
            });
        }

        function renderClassMap(){ const g=document.getElementById('classMapGrid'); g.innerHTML=''; for(let i=0; i<19; i++){ let d=document.createElement('div'); d.className='dot-map'; d.style.background=['#00b894','#ff7675','#74b9ff'][Math.floor(Math.random()*3)]; g.appendChild(d); } let me=document.createElement('div'); me.className='dot-map'; me.id='myMapDot'; me.style.border='2px solid #333'; me.innerText='ME'; g.insertBefore(me, g.firstChild); }
        function initAudio(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }
        function playWhiteNoise(){ initAudio(); const b=audioCtx.createBuffer(1, audioCtx.sampleRate*2, audioCtx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1; whiteNoiseSource=audioCtx.createBufferSource(); whiteNoiseSource.buffer=b; whiteNoiseSource.loop=true; const g=audioCtx.createGain(); g.gain.value=0.1; whiteNoiseSource.connect(g); g.connect(audioCtx.destination); whiteNoiseSource.start(); }
        function stopWhiteNoise(){ if(whiteNoiseSource){ whiteNoiseSource.stop(); whiteNoiseSource=null; } }
        let resetInt;
        window.activateReset=function(){ document.getElementById('resetOverlay').style.display='flex'; try{playWhiteNoise();}catch(e){} let t=30; resetInt=setInterval(()=>{ t--; document.getElementById('resetCount').innerText=t; if(t<=0) closeReset(); },1000); }
        window.closeReset=function(){ clearInterval(resetInt); document.getElementById('resetOverlay').style.display='none'; stopWhiteNoise(); addMessage("Ch√†o m·ª´ng c·∫≠u quay l·∫°i! üåø", 'ai'); }

        // B·∫Øt ph√≠m Enter
        document.getElementById('userInput').addEventListener("keypress", e=>{if(e.key==="Enter") handleChat()});
    </script>
</body>
</html>
