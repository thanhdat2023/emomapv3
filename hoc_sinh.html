<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitty AI - Instant Chat</title>
    <style>
        /* --- C·∫§U H√åNH GIAO DI·ªÜN (GI·ªÆ NGUY√äN) --- */
        :root { --primary: #ff9f43; --bg-color: #fff0e6; --chat-ai: #ffffff; }
        body.theme-sad { --primary: #74b9ff; --bg-color: #f1f7ff; }
        body.theme-stress { --primary: #ff7675; --bg-color: #fff0f0; }
        body.theme-happy { --primary: #00b894; --bg-color: #e6fffa; }
        body.theme-anxious { --primary: #a29bfe; --bg-color: #f8f0ff; }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; transition: all 0.3s ease; }
        body { background-color: var(--bg-color); display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }

        /* APP CONTAINER */
        .app-container { width: 100%; max-width: 450px; height: 95vh; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.15); display: flex; flex-direction: column; position: relative; overflow: hidden; border: 2px solid var(--primary); }

        /* CHAT SCREEN (HI·ªÜN LU√îN) */
        #screen-chat { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: white; z-index: 10; display: flex; flex-direction: column; 
            overflow: hidden; 
        }

        .header { padding: 15px; background: var(--primary); color: white; display: flex; align-items: center; justify-content: space-between; z-index: 20; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .avatar-wrapper { width: 40px; height: 40px; }
        .kitty-svg { width: 100%; height: 100%; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2)); }
        
        .chat-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background: rgba(255,255,255,0.6); scroll-behavior: smooth; }
        .msg { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 0.95rem; line-height: 1.5; word-wrap: break-word; animation: fadeUp 0.3s ease; }
        .msg.ai { align-self: flex-start; background: var(--chat-ai); color: #333; border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .msg.user { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }

        .typing { display: none; gap: 5px; padding: 10px; margin-left: 10px; background: white; border-radius: 15px; width: fit-content; }
        .dot { width: 6px; height: 6px; background: #ccc; border-radius: 50%; animation: blink 1.4s infinite both; }
        .dot:nth-child(2) { animation-delay: 0.2s; } .dot:nth-child(3) { animation-delay: 0.4s; }

        /* INPUT AREA */
        .input-container { min-height: 70px; background: white; border-top: 1px solid #eee; display: flex; align-items: center; justify-content: center; padding: 10px; position: relative; z-index: 30; }
        #text-input-mode { width: 100%; display: flex; gap: 10px; align-items: center; }
        input { flex: 1; padding: 12px; border: 2px solid #eee; border-radius: 20px; outline: none; }
        .send-btn { padding: 10px 15px; background: var(--primary); border: none; border-radius: 50%; color: white; cursor: pointer; font-size: 1rem; }

        /* TOOLS BAR */
        .tools-bar { display: grid; grid-template-columns: 1fr 1fr 1fr; background: #fafafa; border-top: 1px solid #eee; padding: 8px 0; }
        .tool-btn { background: none; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; color: #888; font-size: 0.75rem; }
        .tool-btn:hover { color: var(--primary); }
        
        .float-reset { position: absolute; bottom: 130px; right: 15px; width: 45px; height: 45px; background: white; border: 2px solid var(--primary); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.1); cursor: pointer; z-index: 50; }
        
        /* MODALS */
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; display: none; flex-direction: column; padding: 20px; animation: slideUp 0.3s; }
        .modal.active { display: flex; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: bold; color: var(--primary); font-size: 1.2rem; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .close-btn { cursor: pointer; background: none; border: none; font-size: 1.5rem; }
        .therapy-item { background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .therapy-btn-mini { background: var(--primary); color: white; border: none; padding: 5px 15px; border-radius: 15px; cursor: pointer; font-size: 0.8rem; }
        .map-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 20px; }
        .dot-map { width: 35px; height: 35px; border-radius: 50%; background: #eee; display: flex; justify-content: center; align-items: center; font-size: 0.6rem; color: white; font-weight: bold; }
        #resetOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #a8e6cf, #dcedc1); z-index: 300; display: none; flex-direction: column; justify-content: center; align-items: center; color: #2d3436; }
        .reset-circle { width: 150px; height: 150px; border: 5px solid white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 2.5rem; font-weight: bold; color: white; animation: breathe 8s infinite; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes breathe { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        @keyframes blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-2px); } 75% { transform: translateX(2px); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        
        <div id="screen-chat" class="screen active">
            <div class="header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <div class="avatar-wrapper">
                        <svg class="kitty-svg" viewBox="0 0 512 512"><path fill="#fff" d="M256 0C114.6 0 0 114.6 0 256s114.6 256 256 256s256-114.6 256-256S397.4 0 256 0z"/><path fill="#333" d="M368 152a24 24 0 1 1 0 48 24 24 0 1 1 0-48zM144 152a24 24 0 1 1 0 48 24 24 0 1 1 0-48z"/><path fill="#e55039" d="M256 270c-10 0-18 5-18 12s8 12 18 12s18-5 18-12s-8-12-18-12z"/><path fill="#ff9f43" d="M376.6 96c-13.7-13.7-32-21.4-51.7-21.4H187.1c-19.7 0-38 7.7-51.7 21.4C122.1 110.1 114.6 128.4 114.6 148.1V176c0 8.8 7.2 16 16 16h256c8.8 0 16-7.2 16-16v-27.9c0-19.7-7.5-38-21.4-51.7z"/></svg>
                    </div>
                    <div>
                        <div style="font-weight: bold;">Kitty AI</div>
                        <div style="font-size: 0.7rem; opacity: 0.9;" id="statusText">Tr·ª£ l√Ω c·ªßa b·∫°n</div>
                    </div>
                </div>
                <div class="mhi-score"><span id="mhiScore">75</span>/100</div>
            </div>

            <div class="chat-area" id="chatBox"></div>
            <div class="typing" id="typingIndicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
            
            <div class="float-reset" onclick="activateReset()" title="Reset T√¢m Tr√≠"><i class="fas fa-redo"></i></div>

            <div class="input-container">
                <div id="text-input-mode">
                    <input type="text" id="userInput" placeholder="Nh·∫Øn tin v·ªõi AI..." autocomplete="off">
                    <button class="send-btn" onclick="handleChat()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>

            <div class="tools-bar">
                <button class="tool-btn" onclick="toggleModal('statsModal')"><i class="fas fa-chart-line"></i> Th·ªëng k√™</button>
                <button class="tool-btn" onclick="toggleModal('therapyModal')"><i class="fas fa-heartbeat"></i> Tr·ªã li·ªáu</button>
                <button class="tool-btn" onclick="toggleModal('mapModal')"><i class="fas fa-users"></i> L·ªõp h·ªçc</button>
            </div>
        </div>

        <div class="modal" id="statsModal"><div class="modal-header"><span>üìÖ Nh·∫≠t K√Ω</span><button class="close-btn" onclick="toggleModal('statsModal')">√ó</button></div><div id="timelineContent"></div></div>
        <div class="modal" id="mapModal"><div class="modal-header"><span>üó∫Ô∏è B·∫£n ƒê·ªì L·ªõp</span><button class="close-btn" onclick="toggleModal('mapModal')">√ó</button></div><div class="map-grid" id="classMapGrid"></div></div>
        <div class="modal" id="therapyModal"><div class="modal-header"><span>üíä Tr·ªã Li·ªáu</span><button class="close-btn" onclick="toggleModal('therapyModal')">√ó</button></div><div class="therapy-item"><span>H√≠t th·ªü 4-7-8</span><button class="therapy-btn-mini" onclick="startExercise('breath')">T·∫≠p</button></div><div class="therapy-item"><span>Du·ªói c·ªï vai</span><button class="therapy-btn-mini" onclick="startExercise('stretch')">T·∫≠p</button></div><div class="therapy-item"><span>Grounding</span><button class="therapy-btn-mini" onclick="startExercise('grounding')">T·∫≠p</button></div></div>
        <div id="resetOverlay"><h2>Th∆∞ gi√£n...</h2><div class="reset-circle" id="resetCount">30</div><p>Ti·∫øng ·ªìn tr·∫Øng</p><button onclick="closeReset()" style="margin-top:30px; padding:10px 30px; border-radius:20px; border:none; font-weight:bold;">ƒê√£ ·ªïn h∆°n</button></div>
    </div>

    <script>
        // ============================================================
        // ‚ö†Ô∏è D√ÅN KEY GROQ V√ÄO ƒê√ÇY
        const API_KEY = "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"; 
        // ============================================================

        // LINK NH·∫†C
        const LINK_VUI = "https://open.spotify.com/embed/playlist/4lPLZ0npUWzSpeg0BPOVdp?si=UjYu0QMTTiudxfcW1kPKxg";
        const LINK_LOFI = "https://open.spotify.com/embed/playlist/0jSMk9A4W6wnFUkfrBuRaG?si=-W7y9Rc6Sxq_k6MhiTugRw";

        let messages = []; 
        let mhiScore = 75;
        let history = JSON.parse(localStorage.getItem('emotionHistory')) || [];
        let audioCtx, whiteNoiseSource;

        // --- H√ÄM KH·ªûI T·∫†O (CH·∫†Y NGAY KHI M·ªû WEB) ---
        window.onload = function() {
            if(!API_KEY || API_KEY.includes("D√ÅN_KEY")) {
                alert("‚ùå L·ªói: B·∫°n ch∆∞a d√°n API Key Groq v√†o code!");
                return;
            }

            renderClassMap();
            
            // AI ch√†o m·ªü ƒë·∫ßu
            const greeting = "Ch√†o b·∫°n! M√¨nh c√≥ th·ªÉ gi√∫p g√¨ b·∫°n h√¥m nay? üò∫";
            addMessage(greeting, 'ai');
            
            // Thi·∫øt l·∫≠p Prompt cho AI
            const systemPrompt = `B·∫°n l√† Kitty AI, m·ªôt ng∆∞·ªùi b·∫°n t√¢m l√Ω h·ªçc ƒë∆∞·ªùng th√¢n thi·ªán.
            Quy t·∫Øc:
            1. Lu√¥n l·∫Øng nghe v√† ƒë·ªìng c·∫£m. D√πng t·ª´ "m√¨nh" v√† "b·∫°n".
            2. N·∫øu ng∆∞·ªùi d√πng bu·ªìn/stress -> An ·ªßi v√† h·ªèi: "B·∫°n c√≥ mu·ªën nghe nh·∫°c Lofi kh√¥ng?".
            3. N·∫øu ng∆∞·ªùi d√πng ƒë·ªìng √Ω nghe nh·∫°c (c√≥, ok, uhm...) -> CH·ªà TR·∫¢ L·ªúI DUY NH·∫§T C·ª§M T·ª™: "PLAY_SPOTIFY_NOW".
            4. Tr·∫£ l·ªùi ng·∫Øn g·ªçn, ·∫•m √°p.`;

            messages.push({ role: "system", content: systemPrompt });
            messages.push({ role: "assistant", content: greeting });
            
            document.getElementById('statusText').innerText = "Groq AI Online ‚ö°";
        };

        // --- X·ª¨ L√ù CHAT ---
        async function handleChat() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if(!text) return;

            addMessage(text, 'user');
            input.value = '';
            document.getElementById('typingIndicator').style.display = 'flex';
            
            messages.push({ role: "user", content: text });

            try {
                const aiText = await callGroqAPI(messages);
                document.getElementById('typingIndicator').style.display = 'none';
                
                messages.push({ role: "assistant", content: aiText });
                processAIResponse(aiText);
                saveHistory(text, aiText);
            } catch (error) {
                document.getElementById('typingIndicator').style.display = 'none';
                addMessage(`‚ö†Ô∏è L·ªói k·∫øt n·ªëi: ${error.message}`, 'ai');
            }
        }

        async function callGroqAPI(msgs) {
            const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                body: JSON.stringify({ model: "llama-3.3-70b-versatile", messages: msgs, temperature: 0.7 })
            });
            if (!response.ok) throw new Error((await response.json()).error.message);
            return (await response.json()).choices[0].message.content;
        }

        function processAIResponse(text) {
            // Check m·∫≠t m√£ b·∫≠t nh·∫°c
            if (text.includes("PLAY_SPOTIFY_NOW")) {
                addMessage("Oki! Nh·∫°c l√™n ngay ƒë√¢y. üé∂", 'ai');
                
                // Logic ch·ªçn nh·∫°c
                const checkText = text.toLowerCase() + " " + (messages[messages.length-2]?.content.toLowerCase() || "");
                let link = LINK_LOFI; 
                if (checkText.includes("vui") || checkText.includes("tuy·ªát") || checkText.includes("h·∫°nh ph√∫c")) {
                    link = LINK_VUI;
                }
                
                addMessage(`<iframe style="border-radius:12px; margin-top:10px;" src="${link}" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>`, 'ai');
            } else {
                addMessage(text.replace(/\*\*/g, ''), 'ai');
            }
            
            // ƒê·ªïi m√†u n·ªÅn
            const t = text.toLowerCase();
            if(t.includes('bu·ªìn')||t.includes('kh√≥c')) changeTheme('sad');
            else if(t.includes('vui')||t.includes('tuy·ªát')) changeTheme('happy');
            else if(t.includes('cƒÉng')||t.includes('lo')) changeTheme('stress');
        }

        // --- C√ÅC T√çNH NƒÇNG PH·ª§ (GI·ªÆ NGUY√äN) ---
        function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
        function playWhiteNoise() {
            initAudio();
            const b = audioCtx.createBuffer(1, audioCtx.sampleRate*2, audioCtx.sampleRate);
            const d = b.getChannelData(0); for(let i=0; i<d.length; i++) d[i]=Math.random()*2-1;
            whiteNoiseSource = audioCtx.createBufferSource(); whiteNoiseSource.buffer=b; whiteNoiseSource.loop=true;
            const g = audioCtx.createGain(); g.gain.value=0.1;
            whiteNoiseSource.connect(g); g.connect(audioCtx.destination); whiteNoiseSource.start();
        }
        function stopWhiteNoise() { if(whiteNoiseSource){ whiteNoiseSource.stop(); whiteNoiseSource=null; } }

        let resetInt;
        window.activateReset = function() {
            document.getElementById('resetOverlay').style.display = 'flex';
            try { playWhiteNoise(); } catch(e){}
            let t=30; document.getElementById('resetCount').innerText=t;
            resetInt = setInterval(()=>{ t--; document.getElementById('resetCount').innerText=t; if(t<=0) closeReset(); },1000);
        }
        window.closeReset = function() {
            clearInterval(resetInt); document.getElementById('resetOverlay').style.display='none'; stopWhiteNoise();
            addMessage("Ch√†o m·ª´ng c·∫≠u quay l·∫°i! üåø", 'ai');
        }

        function renderClassMap() {
            const g = document.getElementById('classMapGrid'); g.innerHTML='';
            for(let i=0; i<19; i++) {
                let d=document.createElement('div'); d.className='dot-map'; d.style.background=['#00b894','#ff7675','#74b9ff','#dfe6e9'][Math.floor(Math.random()*4)];
                g.appendChild(d);
            }
            let me=document.createElement('div'); me.className='dot-map'; me.id='myMapDot'; me.style.border='2px solid #333'; me.innerText='ME';
            g.insertBefore(me, g.firstChild);
        }
        function addMessage(html, type) {
            const b = document.getElementById('chatBox'); const d=document.createElement('div'); d.className=`msg ${type}`; d.innerHTML=html;
            b.appendChild(d); b.scrollTop=b.scrollHeight;
        }
        window.toggleModal = function(id) {
            const m = document.getElementById(id); m.classList.toggle('active');
            if(id==='statsModal' && m.classList.contains('active')) document.getElementById('timelineContent').innerHTML = history.map(h => `<div><small>${h.time}</small><br><b>B·∫°n:</b> ${h.user}<br><b>AI:</b> ${h.ai.substring(0,40)}...</div>`).join('<hr>');
        }
        window.startExercise = function(t) {
            document.getElementById('therapyModal').classList.remove('active');
            let msg = (t==='breath')?"üå¨Ô∏è <b>H√≠t th·ªü:</b> H√≠t 4s - Gi·ªØ 7s - Th·ªü 8s.":(t==='stretch'?"üôÜ <b>C·ªï vai:</b> Nghi√™ng tr√°i ph·∫£i 10s.":"üëÅÔ∏è <b>5-4-3-2-1:</b> T√¨m 5 v·∫≠t nh√¨n th·∫•y.");
            addMessage(msg, 'ai');
        }
        function changeTheme(e) { document.body.className = ''; if(e) document.body.classList.add(`theme-${e}`); }
        function saveHistory(u, a) { history.unshift({ time: new Date().toLocaleTimeString(), user: u, ai: a }); localStorage.setItem('emotionHistory', JSON.stringify(history)); }

        document.getElementById('userInput').addEventListener("keypress", e=>{if(e.key==="Enter") handleChat()});
    </script>
</body>
</html>
