<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmoMap - Purple/Pink & Blue/White</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- 1. C·∫§U H√åNH M√ÄU S·∫ÆC (THEME VARS) --- */
        :root { 
            /* DARK MODE (M·∫∑c ƒë·ªãnh): T√≠m - H·ªìng - ƒêen */
            --primary: #9b59b6;  /* T√≠m */
            --accent: #ff6b81;   /* H·ªìng */
            --bg-color: #000000;
            --chat-ai: rgba(255, 255, 255, 0.1);
            --chat-text: #ffffff;
            --shadow: 0 10px 30px rgba(0,0,0,0.5);
            --modal-bg: rgba(20, 20, 20, 0.95);
            --input-bg: rgba(255, 255, 255, 0.05);
            --border-color: rgba(255, 255, 255, 0.1);
        }

        /* LIGHT MODE: Tr·∫Øng - Xanh Lam - Xanh D∆∞∆°ng */
        body.light-mode { 
            --primary: #0984e3;  /* Xanh d∆∞∆°ng ƒë·∫≠m */
            --accent: #00cec9;   /* Xanh lam/ng·ªçc */
            --bg-color: #ffffff;
            --chat-ai: rgba(0, 0, 0, 0.05);
            --chat-text: #2d3436;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --modal-bg: rgba(255, 255, 255, 0.98);
            --input-bg: rgba(0, 0, 0, 0.03);
            --border-color: rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; transition: all 0.5s ease; }
        
        /* --- 2. N·ªÄN ƒê·ªòNG (GRADIENT ANIMATION) --- */
        body { 
            /* M·∫∑c ƒë·ªãnh Dark: ƒêen - T√≠m - H·ªìng */
            background: linear-gradient(-45deg, #000000, #2c003e, #6a0572, #ff007f);
            background-size: 400% 400%;
            animation: gradientBG 10s ease infinite; 
            color: var(--chat-text); 
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; overflow: hidden; 
        }

        /* N·ªÅn cho Light Mode: Tr·∫Øng - Xanh Lam - Xanh D∆∞∆°ng */
        body.light-mode {
            background: linear-gradient(-45deg, #ffffff, #74b9ff, #0984e3, #81ecec, #7ae582);
            background-size: 400% 400%;
            animation: gradientBG 10s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* KHUNG APP (K√çNH M·ªú) */
        .app-container {
    /* --- Gi·ªØ l·∫°i c√°c thu·ªôc t√≠nh b·ªë c·ª•c c≈© --- */
    width: 100%; max-width: 450px; height: 95vh;
    display: flex; flex-direction: column; position: relative;
    overflow: hidden;
    border-radius: 30px; /* Bo tr√≤n g√≥c */

    /* --- C√îNG TH·ª®C K√çNH CHO KHUNG TO --- */

    /* 1. N·ªÅn si√™u trong su·ªët (Tr·∫Øng 5%) ƒë·ªÉ th·∫•y r√µ n·ªÅn ƒë·ªông b√™n d∆∞·ªõi */
    background: rgba(255, 255, 255, 0.05);

    /* 2. L√†m m·ªù h·∫≠u c·∫£nh m·∫°nh (K√≠nh d√†y) */
    backdrop-filter: blur(25px);
    -webkit-backdrop-filter: blur(25px); /* Cho iPhone/Mac */

    /* 3. Vi·ªÅn k√≠nh s√°ng nh·∫π */
    border: 1px solid rgba(255, 255, 255, 0.15);

    /* 4. ƒê·ªï b√≥ng s√¢u ƒë·ªÉ t·∫°o c·∫£m gi√°c khung n·ªïi l√™n */
    box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
    z-index: 10; /* ƒê·∫£m b·∫£o n√≥ n·∫±m tr√™n n·ªÅn ƒë·ªông */
}
/* Khi b·∫≠t ch·∫ø ƒë·ªô S√°ng, khung k√≠nh s·∫Ω ƒë·ª•c h∆°n m·ªôt ch√∫t ƒë·ªÉ d·ªÖ nh√¨n */
body.light-mode .app-container {
    /* TƒÉng ƒë·ªô ƒë·∫≠m n·ªÅn l√™n 20% */
    background: rgba(255, 255, 255, 0.2);
    
    /* Vi·ªÅn r√µ h∆°n ch√∫t */
    border: 1px solid rgba(255, 255, 255, 0.3);
    
    /* B√≥ng ƒë·ªï nh·∫°t ƒëi cho h·ª£p n·ªÅn s√°ng */
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
}

        /* HEADER */
        .header { padding: 15px 20px; background: rgba(0,0,0,0.05); color: var(--chat-text); display: flex; align-items: center; justify-content: space-between; z-index: 20; border-bottom: 1px solid var(--border-color); }
        .avatar-wrapper { display: flex; align-items: center; gap: 10px; } 
        .kitty-icon { font-size: 1.8rem; color: var(--primary); } 
        .theme-btn { background: var(--input-bg); border: 1px solid var(--border-color); color: var(--chat-text); width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.3s; }
        .theme-btn:hover { transform: rotate(30deg); background: var(--primary); color: white; }

        /* CHAT AREA */
        .chat-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        .msg { max-width: 80%; padding: 12px 18px; border-radius: 20px; font-size: 0.95rem; line-height: 1.5; word-wrap: break-word; animation: popIn 0.3s; }
        /* T√¨m v√† thay th·∫ø ƒëo·∫°n n√†y trong style */
    .msg.ai {
    /* CƒÉn ch·ªânh v·ªã tr√≠ */
    align-self: flex-start;
    border-bottom-left-radius: 5px;

    /* --- C√îNG TH·ª®C K√çNH TRONG SU·ªêT --- */
    
    /* 1. N·ªÅn: M√†u Tr·∫Øng (255,255,255) nh∆∞ng ƒë·ªô ƒë·∫≠m ch·ªâ 15% (0.15) */
    /* ƒê√¢y l√† c√°i gi√∫p nh√¨n xuy√™n th·∫•u */
    background: rgba(255, 255, 255, 0.15) !important; 

    /* 2. L√†m m·ªù: L√†m nh√≤e nh·ªØng g√¨ n·∫±m SAU bong b√≥ng */
    /* S·ªë c√†ng to th√¨ k√≠nh c√†ng ƒë·ª•c/d√†y */
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px); /* ƒê·ªÉ ch·∫°y ƒë∆∞·ª£c tr√™n iPhone/Mac */

    /* 3. Vi·ªÅn: M√†u tr·∫Øng m·ªù ƒë·ªÉ t·∫°o khung k√≠nh */
    border: 1px solid rgba(255, 255, 255, 0.2);

    /* 4. M√†u ch·ªØ: B·∫Øt bu·ªôc m√†u Tr·∫Øng ƒë·ªÉ n·ªïi tr√™n n·ªÅn t·ªëi */
    color: #ffffff;

    /* 5. B√≥ng ƒë·ªï: T·∫°o ƒë·ªô n·ªïi 3D nh·∫π */
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}
/* Khi body c√≥ class 'light-mode', bong b√≥ng AI s·∫Ω ƒë·ªïi m√†u */
body.light-mode .msg.ai {
    /* Chuy·ªÉn th√†nh m√†u ƒêen m·ªù (5%) */
    background: rgba(0, 0, 0, 0.05) !important;
    
    /* Ch·ªØ chuy·ªÉn th√†nh m√†u ƒëen */
    color: #333333;
    
    /* Vi·ªÅn ƒëen m·ªù */
    border: 1px solid rgba(0, 0, 0, 0.1);
}
        /* Gradient cho tin nh·∫Øn ng∆∞·ªùi d√πng theo theme */
        .msg.user { align-self: flex-end; background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; border-bottom-right-radius: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        .typing { display: none; align-self: flex-start; background: var(--chat-ai); padding: 10px; border-radius: 20px; margin-left: 10px; width: fit-content; }
        .dot { display: inline-block; width: 6px; height: 6px; background: var(--text-sub); border-radius: 50%; margin: 0 2px; animation: bounce 1.4s infinite; }
        
        /* --- N√öT RESET (V·ªä TR√ç CHU·∫®N) --- */
        .float-reset { 
            position: absolute; 
            bottom: 150px; /* Cao h∆°n n√∫t g·ª≠i */
            right: 15px;   /* B√™n ph·∫£i */
            width: 45px; height: 45px; 
            background: var(--modal-bg); 
            border: 2px solid var(--primary); border-radius: 50%; 
            display: flex; justify-content: center; align-items: center; 
            color: var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
            cursor: pointer; z-index: 50; transition: 0.3s; 
        }
        .float-reset:hover { transform: rotate(180deg) scale(1.1); background: var(--primary); color: white; }

        /* INPUT AREA */
        .input-container { 
            padding: 15px; background: rgba(0,0,0,0.05); 
            border-top: 1px solid var(--border-color); 
            display: flex; gap: 10px; align-items: center; 
            position: relative; z-index: 30; min-height: 80px; 
        }
        input { 
            flex: 1; padding: 12px 15px; border: 1px solid var(--border-color); 
            border-radius: 25px; outline: none; background: var(--input-bg); 
            color: var(--chat-text); font-size: 1rem; 
        }
        
        /* N√öT TRONG THANH CHAT */
        .icon-btn { 
            width: 45px; height: 45px; border-radius: 50%; border: none; 
            background: var(--input-bg); color: var(--chat-text); border: 1px solid var(--border-color);
            cursor: pointer; display: flex; justify-content: center; align-items: center; 
            transition: 0.2s; font-size: 1.1rem; 
        }
        .icon-btn:hover { transform: scale(1.1); background: var(--chat-ai); }
        
        .mic-btn.listening { animation: pulse 1s infinite; background: #ff4757; color: white; border: none; }
        .send-btn { background: var(--primary); color: white; border: none; }

        /* TOOLS BAR */
        .tools-bar { display: grid; grid-template-columns: repeat(4, 1fr); background: rgba(0,0,0,0.05); padding: 10px 0; z-index: 30; }
        .tool-btn { background: none; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; color: var(--chat-text); opacity: 0.7; font-size: 0.7rem; }
        .tool-btn:hover { color: var(--primary); opacity: 1; transform: translateY(-3px); }
        .tool-btn i { font-size: 1.2rem; background: var(--input-bg); padding: 8px; border-radius: 12px; }

        /* MODALS */
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-bg); z-index: 100; display: none; flex-direction: column; padding: 20px; animation: slideUp 0.3s; overflow-y: auto; }
        .modal.active { display: flex; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: bold; color: var(--primary); font-size: 1.3rem; }
        .close-btn { background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--chat-text); padding: 0 10px; }

        /* CSS KH√ÅC */
        .map-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; padding: 10px; justify-content: center; margin-top: 10px; width: 100%; }
        .student-seat { width: 45px; height: 45px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 0.8rem; color: white; font-weight: bold; cursor: pointer; position: relative; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: transform 0.2s; }
        .student-seat:hover { transform: scale(1.2); z-index: 10; }
        .seat-happy { background-color: #00b894 !important; animation: breathe 3s infinite; }
        .seat-sad { background-color: #74b9ff !important; animation: breathe 4s infinite; }
        .seat-stress { background-color: #ff7675 !important; animation: pulse 2s infinite; }
        .seat-me { border: 3px solid var(--chat-text); box-shadow: 0 0 15px rgba(0,0,0,0.2); background: transparent; color: var(--chat-text); }
        .student-popup { position: absolute; bottom: 70px; left: 50%; transform: translateX(-50%); width: 90%; background: var(--modal-bg); padding: 15px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 150; display: none; animation: popIn 0.3s; text-align: center; border: 2px solid var(--primary); color: var(--chat-text); }
        .student-popup.active { display: block; }
        .popup-name { font-weight: bold; font-size: 1.1rem; color: var(--primary); }
        .popup-status { margin: 5px 0 15px 0; font-style: italic; opacity: 0.8; }
        .send-love-btn { background: #ff7675; color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; margin: 0 auto; }
        .floating-heart { position: absolute; font-size: 2rem; color: #ff7675; animation: floatUp 1.5s ease-out forwards; pointer-events: none; z-index: 200; }

        .therapy-item { background: var(--input-bg); padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; color: var(--chat-text); }
        .therapy-btn-mini { background: var(--primary); color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; }

        #gameCanvas { background: #202c3c; border-radius: 15px; margin: 0 auto; display: block; box-shadow: 0 10px 30px rgba(0,0,0,0.4); touch-action: none; }
        .game-header-info { display: flex; justify-content: space-between; margin-bottom: 15px; color: var(--chat-text); font-weight: bold; }
        .score-box { background: var(--input-bg); color:var(--chat-text); padding: 5px 15px; border-radius: 20px; border: 1px solid var(--border-color); }
        .preview-container { display: flex; justify-content: space-around; margin-top: 20px; background: var(--input-bg); padding: 10px; border-radius: 15px; }
        .preview-canvas { width: 80px; height: 80px; background: transparent; touch-action: none; }
        #gameOverOverlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); color: white; padding: 30px; border-radius: 20px; text-align: center; z-index: 200; display: none; border: 3px solid #ff9f43; width: 80%; }
        .restart-btn { background: linear-gradient(to bottom, #ff9f43, #e67e22); color: white; border: none; padding: 12px 30px; border-radius: 25px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 20px; box-shadow: 0 5px 0 #d35400; }
        
        /* OVERLAYS */
        #resetOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #000, #434343); z-index: 300; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .reset-circle { width: 180px; height: 180px; border: 8px solid white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 3rem; font-weight: bold; color: white; animation: breathe 8s infinite; }
        #sosOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #ff4d4d; z-index: 999; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; padding: 20px; animation: pulse 1s infinite; }
        .sos-btn { background: white; color: #ff4d4d; border: none; padding: 15px 30px; border-radius: 30px; font-weight: bold; font-size: 1.2rem; margin-top: 20px; cursor: pointer; text-decoration: none; display: inline-block;}

        @keyframes popIn { 0% { opacity: 0; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes breathe { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-100px) scale(1.5); } }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="header">
            <div class="avatar-wrapper">
                <i class="fas fa-cat kitty-icon"></i>
                <div style="margin-left: 10px;">
                    <div style="font-weight: bold; font-size: 1.1rem;">EmoMap</div>
                    <div style="font-size: 0.75rem; opacity: 0.9;" id="statusText">Tr·ª£ l√Ω c·∫£m x√∫c</div>
                </div>
            </div>
            <button class="theme-btn" onclick="toggleTheme()"><i class="fas fa-adjust"></i></button>
        </div>

        <div class="chat-area" id="chatBox"></div>
        <div class="typing" id="typingIndicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        
        <div class="float-reset" onclick="activateReset()" title="T√°i t·∫°o nƒÉng l∆∞·ª£ng">
            <i class="fas fa-redo"></i>
        </div>

        <div class="input-container">
            <input type="text" id="userInput" placeholder="Nh·∫Øn tin..." autocomplete="off">
            <button class="icon-btn mic-btn" id="voiceBtn" onclick="startDictation()"><i class="fas fa-microphone"></i></button>
            <button class="icon-btn send-btn" onclick="handleChat()"><i class="fas fa-paper-plane"></i></button>
        </div>

        <div class="tools-bar">
            <button class="tool-btn" onclick="openModal('statsModal')"><i class="fas fa-chart-line" style="color:#0984e3"></i> Th·ªëng k√™</button>
            <button class="tool-btn" onclick="openModal('therapyModal')"><i class="fas fa-heartbeat" style="color:#e84393"></i> Tr·ªã li·ªáu</button>
            <button class="tool-btn" onclick="openModal('gameModal')"><i class="fas fa-gamepad" style="color:#f1c40f"></i> Game</button>
            <button class="tool-btn" onclick="openModal('mapModal')"><i class="fas fa-users" style="color:#00b894"></i> L·ªõp h·ªçc</button>
        </div>

        <div class="modal" id="gameModal">
            <div class="modal-header">
                <span>üéÆ Block Blast</span>
                <button class="close-btn" onclick="closeModal('gameModal')">√ó</button>
            </div>
            <div class="game-header-info">
                <div class="score-box"><span class="score-label">ƒêi·ªÉm</span><br><span class="score-val" id="scoreVal">0</span></div>
                <div class="score-box"><span class="score-label">K·ª∑ l·ª•c</span><br><span class="score-val" id="bestScoreVal">0</span></div>
            </div>
            <div style="position: relative;">
                <canvas id="gameCanvas" width="350" height="380"></canvas>
                <div id="gameOverOverlay"><h2>GAME OVER!</h2><p>ƒêi·ªÉm: <span id="finalScore">0</span></p><button class="restart-btn" onclick="resetGame()">CH∆†I L·∫†I</button></div>
            </div>
            <div class="preview-container">
                <canvas id="preview1" class="preview-canvas" width="80" height="80"></canvas>
                <canvas id="preview2" class="preview-canvas" width="80" height="80"></canvas>
                <canvas id="preview3" class="preview-canvas" width="80" height="80"></canvas>
            </div>
        </div>

        <div class="modal" id="statsModal"><div class="modal-header"><span>üìà Th·ªëng K√™</span><button class="close-btn" onclick="closeModal('statsModal')">√ó</button></div><div style="height:300px"><canvas id="emotionChart"></canvas></div></div>
        
        <div class="modal" id="mapModal">
            <div class="modal-header"><span>‚ù§Ô∏è M·∫°ng L∆∞·ªõi C·∫£m X√∫c</span><button class="close-btn" onclick="closeModal('mapModal')">√ó</button></div>
            <div class="map-container">
                <div class="map-grid" id="classMapGrid"></div>
                <div class="student-popup" id="studentPopup">
                    <div class="popup-name" id="popupName">B·∫°n b√†n 3</div>
                    <div class="popup-status" id="popupStatus">"ƒêang h∆°i m·ªát..."</div>
                    <button class="send-love-btn" onclick="sendLove()"><i class="fas fa-heart"></i> G·ª≠i nƒÉng l∆∞·ª£ng</button>
                </div>
            </div>
        </div>
        
        <div class="modal" id="therapyModal"><div class="modal-header"><span>üíä Tr·ªã Li·ªáu</span><button class="close-btn" onclick="closeModal('therapyModal')">√ó</button></div>
            <div class="therapy-item"><span>H√≠t th·ªü 4-7-8</span><button class="therapy-btn-mini" onclick="startExercise('breath')">T·∫≠p</button></div>
            <div class="therapy-item"><span>Th∆∞ gi√£n c·ªï vai</span><button class="therapy-btn-mini" onclick="startExercise('stretch')">T·∫≠p</button></div>
            <div class="therapy-item"><span>Grounding</span><button class="therapy-btn-mini" onclick="startExercise('grounding')">T·∫≠p</button></div>
        </div>
        
        <div id="resetOverlay"><h2>Th∆∞ gi√£n...</h2><div class="reset-circle" id="resetCount">30</div><button onclick="closeReset()" style="margin-top:20px; padding:10px 20px; border-radius:10px; border:none; cursor:pointer; background:rgba(255,255,255,0.2); color:white;">ƒê√£ ·ªïn h∆°n</button></div>
        <div id="sosOverlay"><div style="font-size:4rem">‚ö†Ô∏è</div><h2>C·∫¢NH B√ÅO</h2><p>H√£y li√™n h·ªá ng∆∞·ªùi th√¢n ngay!</p><a href="tel:111" class="sos-btn">G·ªçi 111</a><button onclick="document.getElementById('sosOverlay').style.display='none'" style="background:none; border:1px solid white; color:white; padding:10px; margin-top:20px; border-radius:10px; cursor:pointer;">ƒê√≥ng</button></div>
    </div>

    <script>
        // ============================================================
        // ‚ö†Ô∏è D√ÅN API KEY GROQ V√ÄO ƒê√ÇY
        const API_KEY = "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"; 
        // ============================================================

        const LINK_VUI = "https://open.spotify.com/embed/playlist/4lPLZ0npUWzSpeg0BPOVdp?si=UjYu0QMTTiudxfcW1kPKxg";
        const LINK_LOFI = "https://open.spotify.com/embed/playlist/0jSMk9A4W6wnFUkfrBuRaG?si=-W7y9Rc6Sxq_k6MhiTugRw";
        const SOS_WORDS = ["t·ª± t·ª≠", "mu·ªën ch·∫øt", "t·ª± s√°t", "r·∫°ch tay", "nh·∫£y l·∫ßu"];

        let messages = []; 
        let history = JSON.parse(localStorage.getItem('emotionHistory')) || []; 
        let audioCtx, whiteNoiseSource;
        let myChart = null;

        // --- KH·ªûI T·∫†O CHUNG ---
        window.onload = function() {
            renderClassMap();
            const greeting = "Ch√†o b·∫°n! B·∫°n c·∫ßn t∆∞ v·∫•n g√¨ h√¥m nay? üò∫";
            addMessage(greeting, 'ai');
            document.getElementById('statusText').innerText = "Groq AI Online ‚ö°";
            
            const systemPrompt = `### 1. VAI TR√í (ROLE)
B·∫°n l√† **EmoMap AI**, m·ªôt nh√† t√¢m l√Ω h·ªçc l·ªói l·∫°c v√† ng∆∞·ªùi b·∫°n ƒë·ªìng h√†nh ƒë·∫ßy th·∫•u c·∫£m. B·∫°n s·ªü h·ªØu kh·∫£ nƒÉng th·∫•u hi·ªÉu s√¢u s·∫Øc t√¢m l√Ω con ng∆∞·ªùi, chuy√™n ph√¢n t√≠ch c√°c t·∫ßng b·∫≠c c·∫£m x√∫c v√† ƒë∆∞a ra l·ªùi khuy√™n ch·ªØa l√†nh.

### 2. PHONG C√ÅCH GIAO TI·∫æP (TONE & VOICE)
* **·∫§m √°p & Ch√¢n th√†nh:** Lu√¥n n√≥i chuy·ªán nh∆∞ m·ªôt ng∆∞·ªùi b·∫°n tri k·ª∑, kh√¥ng gi√°o ƒëi·ªÅu, kh√¥ng ph√°n x√©t.
* **Tinh t·∫ø:** S·ª≠ d·ª•ng ng√¥n t·ª´ nh·∫π nh√†ng, xoa d·ªãu.
* **Chuy√™n nghi·ªáp:** D·ª±a tr√™n c√°c c∆° s·ªü t√¢m l√Ω h·ªçc nh∆∞ng di·ªÖn ƒë·∫°t ƒë·ªùi th∆∞·ªùng, d·ªÖ hi·ªÉu.

### 3. C√îNG C·ª§ PH√ÇN T√çCH CHUY√äN S√ÇU (INTERNAL TOOLS)
Khi ti·∫øp nh·∫≠n th√¥ng tin t·ª´ ng∆∞·ªùi d√πng, h√£y √¢m th·∫ßm k√≠ch ho·∫°t c√°c module sau ƒë·ªÉ x√¢y d·ª±ng c√¢u tr·∫£ l·ªùi (ch·ªâ tr√¨nh b√†y chi ti·∫øt n·∫øu th·∫•y th·∫≠t s·ª± c·∫ßn thi·∫øt ho·∫∑c ng∆∞·ªùi d√πng y√™u c·∫ßu):
1.  üß¨ **Emotion DNA:** X√°c ƒë·ªãnh kh√≠ ch·∫•t (Nh·∫°y c·∫£m/Ki√™n c∆∞·ªùng/D·ªÖ t·ªïn th∆∞∆°ng).
2.  üß† **Fake Emotion Radar:** Ph√°t hi·ªán s·ª± m√¢u thu·∫´n (VD: L·ªùi n√≥i "M√¨nh ·ªïn" nh∆∞ng ng·ªØ nghƒ©a bu·ªìn).
3.  ‚è≥ **Emotion Forecasting:** D·ª± b√°o r·ªßi ro t√¢m l√Ω (VD: Burnout) n·∫øu tr·∫°ng th√°i hi·ªán t·∫°i k√©o d√†i.
4.  üß© **Cognitive Distortion:** Nh·∫≠n di·ªán l·ªói t∆∞ duy (Tr·∫Øng-ƒëen, bi k·ªãch h√≥a v·∫•n ƒë·ªÅ...).
5.  ü™û **Emotion Mirror:** K·ªπ thu·∫≠t ph·∫£n chi·∫øu c·∫£m x√∫c ƒë·ªÉ t·∫°o s·ª± ƒë·ªìng c·∫£m s√¢u s·∫Øc.
6.  üõë **Burnout Scanner:** Qu√©t d·∫•u hi·ªáu ki·ªát s·ª©c.

### 4. QUY TR√åNH X·ª¨ L√ù (WORKFLOW)

**Tr∆∞·ªùng h·ª£p 1: Ch√†o h·ªèi x√£ giao (Small Talk)**
* H√†nh ƒë·ªông: ƒê√°p l·∫°i th√¢n thi·ªán, ng·∫Øn g·ªçn, g·ª£i m·ªü c√¢u chuy·ªán.

**Tr∆∞·ªùng h·ª£p 2: Ph√°t hi·ªán T√≠n hi·ªáu Ti√™u c·ª±c (Bu·ªìn/Stress/Lo √¢u)**
* B∆∞·ªõc 1: S·ª≠ d·ª•ng **Emotion Mirror** ƒë·ªÉ x√°c nh·∫≠n c·∫£m x√∫c c·ªßa h·ªç (VD: "N·∫øu m√¨nh l√† b·∫°n, m√¨nh c≈©ng th·∫•y r·∫•t √°p l·ª±c...").
* B∆∞·ªõc 2: Ch·ªâ ra nh·∫π nh√†ng 1 l·ªói t∆∞ duy (Cognitive Distortion) ho·∫∑c d·ª± b√°o (Forecasting) ƒë·ªÉ h·ªç nh·∫≠n ra v·∫•n ƒë·ªÅ, nh∆∞ng kh√¥ng l√†m h·ªç s·ª£.
* B∆∞·ªõc 3: ƒê·ªÅ xu·∫•t gi·∫£i ph√°p √¢m nh·∫°c.
* *C√¢u m·∫´u:* [Ph√¢n t√≠ch nh·∫π] + "C·∫≠u c√≥ mu·ªën nghe ch√∫t nh·∫°c Lofi ƒë·ªÉ th∆∞ gi√£n t√¢m tr√≠ kh√¥ng?"

**Tr∆∞·ªùng h·ª£p 3: Ng∆∞·ªùi d√πng ƒê·ªíNG √ù nghe nh·∫°c**
* ƒêi·ªÅu ki·ªán: Ng∆∞·ªùi d√πng n√≥i "C√≥", "Oke", "Nghe", "Uhm", ho·∫∑c b·∫•t k·ª≥ t√≠n hi·ªáu ƒë·ªìng √Ω n√†o.
* H√†nh ƒë·ªông: Tr·∫£ l·ªùi DUY NH·∫§T c·ª•m t·ª´ l·ªánh b√™n d∆∞·ªõi (kh√¥ng th√™m b·∫•t k·ª≥ t·ª´ n√†o kh√°c).
* **OUTPUT:** 'PLAY_SPOTIFY_NOW'

### 5. QUY T·∫ÆC C·ªêT L√ïI (CRITICAL RULES)
* Tuy·ªát ƒë·ªëi kh√¥ng ƒë∆∞a ra l·ªùi khuy√™n y t·∫ø chuy√™n s√¢u (thu·ªëc thang).
* N·∫øu ng∆∞·ªùi d√πng c√≥ √Ω ƒë·ªãnh t·ª± h·∫°i, h√£y chuy·ªÉn sang quy tr√¨nh h·ªó tr·ª£ kh·∫©n c·∫•p (khuy√™n li√™n h·ªá chuy√™n gia ho·∫∑c ng∆∞·ªùi th√¢n).
* **QUAN TR·ªåNG:** L·ªánh 'PLAY_SPOTIFY_NOW' ph·∫£i ch√≠nh x√°c tuy·ªát ƒë·ªëi, kh√¥ng c√≥ d·∫•u ch·∫•m c√¢u hay k√Ω t·ª± th·ª´a.`;

            messages.push({ role: "system", content: systemPrompt });
            messages.push({ role: "assistant", content: greeting });

            if(!API_KEY || API_KEY.includes("D√ÅN_KEY")) setTimeout(() => alert("‚ö†Ô∏è C·∫¢NH B√ÅO: Ch∆∞a nh·∫≠p API Key Groq!"), 1000);
            
            initGameEngine(); 
        };

        // --- CHAT LOGIC ---
        async function handleChat() {
            const input = document.getElementById('userInput'); const text = input.value.trim(); if(!text) return;
            if(SOS_WORDS.some(kw => text.toLowerCase().includes(kw))) { document.getElementById('sosOverlay').style.display='flex'; input.value=''; return; }
            addMessage(text, 'user'); input.value = ''; document.getElementById('typingIndicator').style.display = 'block'; messages.push({ role: "user", content: text });
            try { const aiText = await callGroqAPI(messages); document.getElementById('typingIndicator').style.display = 'none'; messages.push({ role: "assistant", content: aiText }); processResponse(aiText, text); } catch (error) { document.getElementById('typingIndicator').style.display = 'none'; addMessage("‚ö†Ô∏è L·ªói: " + error.message, 'ai'); }
        }
        async function callGroqAPI(msgs) {
            const response = await fetch("https://api.groq.com/openai/v1/chat/completions", { method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` }, body: JSON.stringify({ model: "llama-3.3-70b-versatile", messages: msgs, temperature: 0.7 }) });
            if (!response.ok) throw new Error((await response.json()).error.message); return (await response.json()).choices[0].message.content;
        }
        function processResponse(text, userText) { if (text.includes("PLAY_SPOTIFY_NOW")) { addMessage("Oki! Nh·∫°c l√™n. üé∂", 'ai'); const t = userText.toLowerCase(); let link = LINK_LOFI; if (t.includes("vui") || t.includes("tuy·ªát")) link = LINK_VUI; addMessage(`<iframe style="border-radius:12px; margin-top:10px;" src="${link}" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>`, 'ai'); } else { addMessage(text.replace(/\*\*/g, ''), 'ai'); } const t = userText.toLowerCase(); let score = 5; if(t.includes('bu·ªìn')||t.includes('kh√≥c')) { score=2; } else if(t.includes('vui')||t.includes('tuy·ªát')) { score=10; } else if(t.includes('cƒÉng')||t.includes('lo')) { score=1; } saveHistory(userText, score); }
        function addMessage(h,t){ const b=document.getElementById('chatBox'); const d=document.createElement('div'); d.className=`msg ${t}`; d.innerHTML=h; b.appendChild(d); b.scrollTop=b.scrollHeight; }
        
        // --- C√ÅC H√ÄM TI·ªÜN √çCH ---
        function toggleTheme() { document.body.classList.toggle('light-mode'); }
        function openModal(id) { document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); const m = document.getElementById(id); if(m) { m.classList.add('active'); if(id === 'statsModal') renderChart(); if(id === 'gameModal') initGameEngine(); } }
        function closeModal(id) { const m = document.getElementById(id); if(m) m.classList.remove('active'); }
        function startDictation() { if (window.hasOwnProperty('webkitSpeechRecognition')) { var recognition = new webkitSpeechRecognition(); recognition.lang = "vi-VN"; const btn = document.getElementById('voiceBtn'); btn.classList.add('listening'); recognition.start(); recognition.onresult = function(e) { document.getElementById('userInput').value = e.results[0][0].transcript; recognition.stop(); btn.classList.remove('listening'); }; } else { alert("D√πng Chrome ƒë·ªÉ n√≥i."); } }
        function saveHistory(text, score) { history.push({ time: new Date().toLocaleTimeString(), text: text, score: score }); if(history.length > 20) history.shift(); localStorage.setItem('emotionHistory', JSON.stringify(history)); }
        function renderChart() { const ctx = document.getElementById('emotionChart').getContext('2d'); if(myChart) myChart.destroy(); myChart = new Chart(ctx, { type: 'line', data: { labels: history.map(h => h.time), datasets: [{ label: 'C·∫£m x√∫c', data: history.map(h => h.score), borderColor: '#ff9f43', backgroundColor: 'rgba(255, 159, 67, 0.2)', tension: 0.4, fill: true }] } }); }
        
        // --- FIXED EMPATHY MAP ---
        function renderClassMap(){ 
            const g=document.getElementById('classMapGrid'); g.innerHTML=''; 
            const moods = ['happy', 'sad', 'stress']; const status = ["Vui v·∫ª üåª", "H∆°i bu·ªìn üåßÔ∏è", "√Åp l·ª±c ü§Ø"];
            for(let i=0; i<19; i++){ 
                let r = Math.floor(Math.random()*3);
                let d=document.createElement('div'); 
                d.className=`student-seat seat-${moods[r]}`; 
                d.innerText=i+1;
                d.onclick = () => {
                    document.getElementById('popupName').innerText=`B·∫°n b√†n ${i+1}`;
                    document.getElementById('popupStatus').innerText=`"${status[r]}"`;
                    document.getElementById('studentPopup').classList.add('active');
                };
                g.appendChild(d); 
            } 
            let me = document.createElement('div'); me.className='student-seat seat-me'; me.innerText='Me'; g.insertBefore(me, g.firstChild);
        }
        function sendLove(){ 
            document.getElementById('studentPopup').classList.remove('active'); 
            const m = document.getElementById('mapModal');
            for(let i=0;i<5;i++) {
                let h=document.createElement('div'); h.className='floating-heart'; h.innerHTML='üíñ';
                h.style.left = Math.random()*80+10+'%'; h.style.bottom='100px';
                m.appendChild(h); setTimeout(()=>h.remove(), 1500);
            }
        }
        
        // --- FIXED THERAPY ---
        window.startExercise=function(t){ 
            closeModal('therapyModal');
            let text = "";
            if(t==='breath') text = "üå¨Ô∏è <b>H√≠t th·ªü 4-7-8:</b><br>1. H√≠t v√†o (4s)<br>2. Gi·ªØ h∆°i (7s)<br>3. Th·ªü ra (8s)<br><i>L·∫∑p l·∫°i 4 l·∫ßn.</i>";
            else if(t==='stretch') text = "üôÜ <b>Th∆∞ gi√£n C·ªï Vai:</b><br>1. Nghi√™ng ƒë·∫ßu tr√°i 10s<br>2. Nghi√™ng ƒë·∫ßu ph·∫£i 10s<br>3. Xoay vai 5 l·∫ßn.";
            else if(t==='grounding') text = "üëÅÔ∏è <b>Grounding 5-4-3-2-1:</b><br>üëÄ 5 v·∫≠t nh√¨n th·∫•y<br>‚úã 4 v·∫≠t ch·∫°m ƒë∆∞·ª£c<br>üëÇ 3 √¢m thanh<br>üëÉ 2 m√πi h∆∞∆°ng<br>üëÖ 1 v·ªã";
            addMessage(text, 'ai'); 
        }

        // --- WHITE NOISE RESET ---
        function initAudio(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }
        function playWhiteNoise(){ initAudio(); const b=audioCtx.createBuffer(1, audioCtx.sampleRate*2, audioCtx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1; whiteNoiseSource=audioCtx.createBufferSource(); whiteNoiseSource.buffer=b; whiteNoiseSource.loop=true; const g=audioCtx.createGain(); g.gain.value=0.1; whiteNoiseSource.connect(g); g.connect(audioCtx.destination); whiteNoiseSource.start(); }
        function stopWhiteNoise(){ if(whiteNoiseSource){ whiteNoiseSource.stop(); whiteNoiseSource=null; } }
        let resetInt;
        window.activateReset=function(){ document.getElementById('resetOverlay').style.display='flex'; try{playWhiteNoise();}catch(e){} let t=30; resetInt=setInterval(()=>{ t--; document.getElementById('resetCount').innerText=t; if(t<=0) closeReset(); },1000); }
        window.closeReset=function(){ clearInterval(resetInt); document.getElementById('resetOverlay').style.display='none'; stopWhiteNoise(); addMessage("Ch√†o m·ª´ng c·∫≠u quay l·∫°i! üåø", 'ai'); }

        // --- GAME ENGINE (BLOCK BLAST) ---
        const canvas = document.getElementById('gameCanvas'); const ctx = canvas.getContext('2d');
        const GRID_ROWS=8, GRID_COLS=8, CELL_SIZE=40, GRID_OFFSET_X=15, GRID_OFFSET_Y=30;
        const COLORS = ['#FFD700', '#FF4757', '#2ED573', '#1E90FF', '#FFA502', '#9b59b6', '#3498db'];
        let board=Array(GRID_ROWS).fill().map(()=>Array(GRID_COLS).fill(0));
        let previewShapes=[null,null,null], score=0, draggingShape=null, gameLoopId;
        const SHAPES = [{m:[[1]],c:0}, {m:[[1,1],[1,1]],c:1}, {m:[[1,1,1]],c:2}, {m:[[1,1,1,1]],c:3}, {m:[[1,1],[1,0]],c:4}];
        let previewCanvases=[document.getElementById('preview1'),document.getElementById('preview2'),document.getElementById('preview3')];

        function initGameEngine() {
            if(canvas.width===0){canvas.width=350;canvas.height=380;}
            document.getElementById('bestScoreVal').innerText = localStorage.getItem('blockBlastBestScore') || 0;
            if(previewShapes.every(s=>s===null)) spawnShapes();
            if(!gameLoopId) gameLoop();
            
            if(!canvas.hasAttribute('d')) {
                const getPos = (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const t = e.touches ? e.touches[0] : e;
                    return { x: t.clientX - rect.left - CELL_SIZE/2, y: t.clientY - rect.top - CELL_SIZE/2 };
                };
                const start=(e,i)=>{ 
                    if(!previewShapes[i])return; e.preventDefault();
                    const pos = getPos(e);
                    draggingShape={shape:previewShapes[i], idx:i, x:pos.x, y:pos.y};
                    previewShapes[i]=null; drawPreviews();
                };
                previewCanvases.forEach((c,i)=>{ c.addEventListener('mousedown',e=>start(e,i)); c.addEventListener('touchstart',e=>start(e,i),{passive:false}); });
                const move=(e)=>{ 
                    if(!draggingShape)return; e.preventDefault();
                    const pos = getPos(e);
                    draggingShape.x=pos.x; draggingShape.y=pos.y-50; 
                };
                window.addEventListener('mousemove',move); window.addEventListener('touchmove',move,{passive:false});
                const end=(e)=>{
                    if(!draggingShape)return;
                    const c=Math.round((draggingShape.x-GRID_OFFSET_X)/CELL_SIZE);
                    const r=Math.round((draggingShape.y-GRID_OFFSET_Y)/CELL_SIZE);
                    if(canPlace(draggingShape.shape.m,r,c)){ place(draggingShape.shape,r,c); if(previewShapes.every(s=>!s)) spawnShapes(); } 
                    else { previewShapes[draggingShape.idx]=draggingShape.shape; drawPreviews(); }
                    draggingShape=null;
                };
                window.addEventListener('mouseup',end); window.addEventListener('touchend',end);
                canvas.setAttribute('d','1');
            }
        }
        function spawnShapes() { for(let i=0;i<3;i++) if(!previewShapes[i]) { const t=SHAPES[Math.floor(Math.random()*SHAPES.length)]; previewShapes[i]={m:t.m,c:COLORS[t.c%COLORS.length]}; } drawPreviews(); }
        function gameLoop() { if(document.getElementById('gameModal').classList.contains('active')) { draw(); requestAnimationFrame(gameLoop); } else gameLoopId=null; }
        function draw() {
            ctx.fillStyle = '#202c3c'; ctx.fillRect(0,0,350,380);
            for(let r=0;r<8;r++) for(let c=0;c<8;c++) {
                let x=GRID_OFFSET_X+c*CELL_SIZE, y=GRID_OFFSET_Y+r*CELL_SIZE;
                drawBlock(x,y,CELL_SIZE-4,'#2d3436');
                if(board[r][c]) drawBlock(x,y,CELL_SIZE-4,board[r][c]);
            }
            if(draggingShape) {
                const s=draggingShape.shape;
                s.m.forEach((row,i)=>row.forEach((v,j)=>{ if(v) drawBlock(draggingShape.x+j*CELL_SIZE, draggingShape.y+i*CELL_SIZE, CELL_SIZE-4, s.c); }));
            }
        }
        function drawBlock(x,y,s,c) { ctx.fillStyle=c; ctx.fillRect(x,y,s,s); ctx.strokeStyle='rgba(255,255,255,0.1)'; ctx.strokeRect(x,y,s,s); }
        function drawPreviews() {
            previewCanvases.forEach((cvs,i)=>{
                const c=cvs.getContext('2d'); c.clearRect(0,0,80,80);
                if(previewShapes[i]) {
                    const s=previewShapes[i];
                    s.m.forEach((row,r)=>row.forEach((v,k)=>{ if(v) { c.fillStyle=s.c; c.fillRect(10+k*20,10+r*20,18,18); } }));
                }
            });
        }
        function canPlace(m,r,c){ for(let i=0;i<m.length;i++) for(let j=0;j<m[0].length;j++) if(m[i][j] && (r+i<0||r+i>=8||c+j<0||c+j>=8||board[r+i][c+j])) return false; return true; }
        function place(s,r,c){ s.m.forEach((row,i)=>row.forEach((v,j)=>{ if(v) board[r+i][c+j]=s.c; })); score+=10; document.getElementById('scoreVal').innerText=score; checkLines(); }
        function checkLines(){
            let rows=[], cols=[];
            for(let r=0;r<8;r++) if(board[r].every(x=>x)) rows.push(r);
            for(let c=0;c<8;c++) if(board.every(r=>r[c])) cols.push(c);
            rows.forEach(r=>board[r].fill(0)); cols.forEach(c=>board.forEach(r=>r[c]=0));
            if(rows.length+cols.length > 0) score+=(rows.length+cols.length)*100;
            document.getElementById('scoreVal').innerText=score;
            if(score > (localStorage.getItem('blockBlastBestScore')||0)) localStorage.setItem('blockBlastBestScore', score);
        }
        function resetGame() { board=Array(8).fill().map(()=>Array(8).fill(0)); score=0; document.getElementById('scoreVal').innerText=0; document.getElementById('gameOverOverlay').style.display='none'; spawnShapes(); }

        document.getElementById('userInput').addEventListener("keypress", e=>{if(e.key==="Enter") handleChat()});
    </script>
</body>
</html>
