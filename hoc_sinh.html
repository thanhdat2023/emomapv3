<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmoMap - Empathy Map</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- GI·ªÆ NGUY√äN GIAO DI·ªÜN C≈® --- */
        :root { --primary: #ff9f43; --bg-color: #fff0e6; --chat-ai: #ffffff; --chat-text: #333; --shadow: 0 10px 30px rgba(0,0,0,0.1); --modal-bg: rgba(255,255,255,0.95); }
        body.dark-mode { --primary: #e67e22; --bg-color: #2d3436; --chat-ai: #636e72; --chat-text: #dfe6e9; --shadow: 0 10px 30px rgba(0,0,0,0.3); --modal-bg: rgba(45, 52, 54, 0.95); }
        body.theme-sad { --primary: #74b9ff; --bg-color: #f1f7ff; } body.dark-mode.theme-sad { --bg-color: #1e272e; --primary: #0984e3; }
        body.theme-stress { --primary: #ff7675; --bg-color: #fff0f0; } body.dark-mode.theme-stress { --bg-color: #2c0b0e; --primary: #d63031; }
        body.theme-happy { --primary: #00b894; --bg-color: #e6fffa; } body.dark-mode.theme-happy { --bg-color: #0c2520; --primary: #00b894; }
        
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; transition: all 0.3s ease; }
        body { background-color: var(--bg-color); color: var(--chat-text); display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        .app-container { width: 100%; max-width: 450px; height: 95vh; background: rgba(255,255,255,0.75); backdrop-filter: blur(20px); border-radius: 30px; box-shadow: var(--shadow); display: flex; flex-direction: column; position: relative; overflow: hidden; border: 2px solid var(--primary); }
        body.dark-mode .app-container { background: rgba(45, 52, 54, 0.8); border-color: #555; }
        .header { padding: 20px; background: var(--primary); color: white; display: flex; align-items: center; justify-content: space-between; z-index: 20; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; }
        .avatar-wrapper { display: flex; align-items: center; gap: 10px; } .kitty-icon { font-size: 1.8rem; } .theme-btn { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }
        .chat-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        .msg { max-width: 80%; padding: 12px 18px; border-radius: 20px; font-size: 0.95rem; line-height: 1.5; word-wrap: break-word; animation: popIn 0.3s; }
        .msg.ai { align-self: flex-start; background: var(--chat-ai); color: var(--chat-text); border-bottom-left-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .msg.user { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 5px; box-shadow: 0 5px 15px rgba(var(--primary), 0.4); }
        .typing { display: none; align-self: flex-start; background: var(--chat-ai); padding: 10px 15px; border-radius: 20px; margin-left: 10px; width: fit-content; margin-bottom: 10px;}
        .dot { display: inline-block; width: 6px; height: 6px; background: #bbb; border-radius: 50%; margin: 0 2px; animation: bounce 1.4s infinite; }
        .dot:nth-child(2) { animation-delay: 0.2s; } .dot:nth-child(3) { animation-delay: 0.4s; }
        .input-area { padding: 15px; background: var(--chat-ai); border-top: 1px solid rgba(0,0,0,0.05); display: flex; gap: 10px; align-items: center; }
        input { flex: 1; padding: 12px 15px; border: none; border-radius: 25px; outline: none; background: rgba(0,0,0,0.05); color: var(--chat-text); font-size: 1rem; }
        .icon-btn { width: 45px; height: 45px; border-radius: 50%; border: none; background: var(--primary); color: white; cursor: pointer; font-size: 1.1rem; display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        .icon-btn:hover { transform: scale(1.1); } .mic-btn { background: #2ecc71; } .mic-btn.listening { animation: pulse 1.5s infinite; background: #e74c3c; }
        .tools-bar { display: grid; grid-template-columns: repeat(3, 1fr); background: var(--chat-ai); padding-bottom: 10px; padding-top: 5px; }
        .tool-btn { background: none; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; color: #888; font-size: 0.75rem; transition: 0.2s; }
        .tool-btn:hover { color: var(--primary); transform: translateY(-3px); } .tool-btn i { font-size: 1.3rem; background: rgba(0,0,0,0.05); padding: 10px; border-radius: 15px; }
        .float-reset { position: absolute; bottom: 160px; right: 20px; width: 50px; height: 50px; background: white; border: 2px solid var(--primary); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: var(--primary); box-shadow: 0 5px 20px rgba(0,0,0,0.2); cursor: pointer; z-index: 50; transition: 0.3s; }
        .float-reset:hover { transform: rotate(180deg) scale(1.1); }
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-bg); z-index: 100; display: none; flex-direction: column; padding: 25px; animation: slideUp 0.4s; }
        .modal.active { display: flex; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: bold; color: var(--primary); font-size: 1.3rem; }
        .close-btn { background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--chat-text); line-height: 1; padding: 0 10px; }
        .therapy-item { background: rgba(0,0,0,0.03); padding: 15px; border-radius: 15px; margin-bottom: 15px; border-left: 5px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .therapy-btn-mini { background: var(--primary); color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; font-weight: bold; }
        #resetOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #a8e6cf, #dcedc1); z-index: 300; display: none; flex-direction: column; justify-content: center; align-items: center; color: #2d3436; animation: fadeIn 0.5s; }
        .reset-circle { width: 180px; height: 180px; border: 8px solid white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 3rem; font-weight: bold; color: white; animation: breathe 8s infinite; }
        #sosOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #ff4d4d; z-index: 999; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; padding: 20px; animation: pulseRed 2s infinite; }
        .sos-btn { background: white; color: #ff4d4d; border: none; padding: 15px 30px; border-radius: 30px; font-weight: bold; font-size: 1.2rem; margin-top: 20px; cursor: pointer; text-decoration: none; display: inline-block;}

        /* --- CSS M·ªöI CHO B·∫¢N ƒê·ªí C·∫¢M X√öC (EMPATHY MAP) --- */
        .map-container { display: flex; flex-direction: column; height: 100%; }
        .map-stats { display: flex; justify-content: space-around; margin-bottom: 15px; background: rgba(0,0,0,0.05); padding: 10px; border-radius: 15px; }
        .stat-item { text-align: center; font-size: 0.8rem; }
        .stat-val { font-weight: bold; font-size: 1.1rem; }
        
        .map-grid { 
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; 
            padding: 10px; overflow-y: auto; align-content: flex-start;
        }
        
        .student-seat { 
            width: 50px; height: 50px; border-radius: 50%; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 0.7rem; color: white; font-weight: bold; 
            cursor: pointer; position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .student-seat:hover { transform: scale(1.1); z-index: 10; }
        
        /* Hi·ªáu ·ª©ng Pulse cho c·∫£m x√∫c */
        .seat-happy { background: #00b894; animation: pulseGreen 2s infinite; }
        .seat-sad { background: #74b9ff; animation: pulseBlue 2s infinite; }
        .seat-stress { background: #ff7675; animation: pulseRed 2s infinite; }
        .seat-me { border: 3px solid #2d3436; box-shadow: 0 0 15px rgba(0,0,0,0.3); }

        /* Popup Th√¥ng tin H·ªçc sinh */
        .student-popup {
            position: absolute; bottom: 70px; left: 50%; transform: translateX(-50%);
            width: 90%; background: white; padding: 15px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 50;
            display: none; animation: popIn 0.3s; text-align: center;
            border: 2px solid var(--primary);
        }
        .student-popup.active { display: block; }
        .popup-name { font-weight: bold; font-size: 1.1rem; color: var(--primary); margin-bottom: 5px; }
        .popup-status { font-size: 0.9rem; color: #555; margin-bottom: 10px; font-style: italic; }
        .send-love-btn { 
            background: #ff7675; color: white; border: none; 
            padding: 8px 20px; border-radius: 20px; cursor: pointer; 
            font-weight: bold; display: flex; align-items: center; gap: 5px; margin: 0 auto;
        }
        .send-love-btn:active { transform: scale(0.95); }

        /* Tim bay */
        .floating-heart { position: absolute; font-size: 1.5rem; color: #ff7675; animation: floatUp 1s ease-out forwards; pointer-events: none; }

        @keyframes popIn { 0% { transform: translate(-50%, 10px); opacity: 0; } 100% { transform: translate(-50%, 0); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
        @keyframes breathe { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(255, 118, 117, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 118, 117, 0); } }
        @keyframes pulseGreen { 0% { box-shadow: 0 0 0 0 rgba(0, 184, 148, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(0, 184, 148, 0); } }
        @keyframes pulseBlue { 0% { box-shadow: 0 0 0 0 rgba(116, 185, 255, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(116, 185, 255, 0); } }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-50px) scale(1.5); } }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="header">
            <div class="avatar-wrapper">
                <i class="fas fa-cat kitty-icon"></i>
                <div style="margin-left: 10px;">
                    <div style="font-weight: bold; font-size: 1.1rem;">EmoMap</div>
                    <div style="font-size: 0.75rem; opacity: 0.9;" id="statusText">Tr·ª£ l√Ω c·∫£m x√∫c</div>
                </div>
            </div>
            <button class="theme-btn" onclick="toggleDarkMode()"><i class="fas fa-moon"></i></button>
        </div>

        <div class="chat-area" id="chatBox"></div>
        <div class="typing" id="typingIndicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        <div class="float-reset" onclick="activateReset()" title="Reset T√¢m Tr√≠"><i class="fas fa-redo"></i></div>

        <div class="input-area">
            <input type="text" id="userInput" placeholder="Nh·∫Øn tin..." autocomplete="off">
            <button class="icon-btn mic-btn" id="voiceBtn" onclick="startDictation()"><i class="fas fa-microphone"></i></button>
            <button class="icon-btn" onclick="handleChat()"><i class="fas fa-paper-plane"></i></button>
        </div>

        <div class="tools-bar">
            <button class="tool-btn" onclick="openModal('statsModal')"><i class="fas fa-chart-line" style="color:#0984e3"></i> Th·ªëng k√™</button>
            <button class="tool-btn" onclick="openModal('therapyModal')"><i class="fas fa-heartbeat" style="color:#e84393"></i> Tr·ªã li·ªáu</button>
            <button class="tool-btn" onclick="openModal('mapModal')"><i class="fas fa-users" style="color:#00b894"></i> L·ªõp h·ªçc</button>
        </div>

        <div class="modal" id="statsModal">
            <div class="modal-header"><span>üìà Bi·ªÉu ƒê·ªì</span><button class="close-btn" onclick="closeModal('statsModal')">√ó</button></div>
            <div style="height: 300px; width: 100%;"><canvas id="emotionChart"></canvas></div>
            <p style="text-align:center; color:#888; font-size:0.8rem; margin-top:10px;">D·ªØ li·ªáu 20 tin nh·∫Øn g·∫ßn nh·∫•t</p>
        </div>

        <div class="modal" id="mapModal">
            <div class="modal-header"><span>‚ù§Ô∏è M·∫°ng L∆∞·ªõi C·∫£m X√∫c</span><button class="close-btn" onclick="closeModal('mapModal')">√ó</button></div>
            <div class="map-container">
                <div class="map-stats">
                    <div class="stat-item"><span class="stat-val" style="color:#00b894">60%</span><br>Vui</div>
                    <div class="stat-item"><span class="stat-val" style="color:#ff7675">15%</span><br>Stress</div>
                    <div class="stat-item"><span class="stat-val" style="color:#74b9ff">25%</span><br>Bu·ªìn</div>
                </div>
                <div class="map-grid" id="classMapGrid"></div>
                <div class="student-popup" id="studentPopup">
                    <div class="popup-name" id="popupName">B·∫°n b√†n 3</div>
                    <div class="popup-status" id="popupStatus">"ƒêang h∆°i m·ªát v√¨ b√†i t·∫≠p..."</div>
                    <button class="send-love-btn" onclick="sendLove()"><i class="fas fa-heart"></i> G·ª≠i nƒÉng l∆∞·ª£ng</button>
                </div>
            </div>
        </div>

        <div class="modal" id="therapyModal">
            <div class="modal-header"><span>üíä G√≥c Tr·ªã Li·ªáu</span><button class="close-btn" onclick="closeModal('therapyModal')">√ó</button></div>
            <div class="therapy-item"><span><i class="fas fa-wind"></i> H√≠t th·ªü 4-7-8</span><button class="therapy-btn-mini" onclick="startExercise('breath')">T·∫≠p</button></div>
            <div class="therapy-item"><span><i class="fas fa-child"></i> Th∆∞ gi√£n c·ªï vai</span><button class="therapy-btn-mini" onclick="startExercise('stretch')">T·∫≠p</button></div>
            <div class="therapy-item"><span><i class="fas fa-hand-holding"></i> K·ªπ thu·∫≠t 5-4-3-2-1</span><button class="therapy-btn-mini" onclick="startExercise('grounding')">T·∫≠p</button></div>
        </div>

        <div id="resetOverlay"><h2>Th∆∞ gi√£n...</h2><div class="reset-circle" id="resetCount">30</div><p>Ti·∫øng ·ªìn tr·∫Øng</p><button onclick="closeReset()" style="margin-top:30px; padding:10px 30px; border-radius:20px; border:none; font-weight:bold; cursor:pointer;">ƒê√£ ·ªïn h∆°n</button></div>
        <div id="sosOverlay"><div style="font-size:4rem">‚ö†Ô∏è</div><h2>C·∫¢NH B√ÅO</h2><p>Ch√∫ng m√¨nh nh·∫≠n th·∫•y b·∫°n ƒëang tr·∫£i qua c·∫£m x√∫c ti√™u c·ª±c. H√£y li√™n h·ªá ng∆∞·ªùi th√¢n ngay!</p><a href="tel:111" class="sos-btn">G·ªçi 111</a><button onclick="document.getElementById('sosOverlay').style.display='none'" style="background:none; border:1px solid white; color:white; padding:10px; margin-top:20px; border-radius:10px; cursor:pointer;">ƒê√≥ng</button></div>
    </div>

    <script>
        // ============================================================
        // ‚ö†Ô∏è D√ÅN API KEY GROQ V√ÄO ƒê√ÇY
        const API_KEY = "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"; 
        // ============================================================

        const LINK_VUI = "https://open.spotify.com/embed/playlist/4lPLZ0npUWzSpeg0BPOVdp?si=UjYu0QMTTiudxfcW1kPKxg";
        const LINK_LOFI = "https://open.spotify.com/embed/playlist/0jSMk9A4W6wnFUkfrBuRaG?si=-W7y9Rc6Sxq_k6MhiTugRw";
        const SOS_WORDS = ["t·ª± t·ª≠", "mu·ªën ch·∫øt", "t·ª± s√°t", "r·∫°ch tay", "nh·∫£y l·∫ßu"];

        // D·ªØ li·ªáu gi·∫£ l·∫≠p cho b·∫£n ƒë·ªì l·ªõp
        const STUDENT_DATA = [
            { id: 1, name: "B·∫°n b√†n 1", mood: "happy", status: "ƒêang nghe nh·∫°c chill üé∂" },
            { id: 2, name: "B·∫°n b√†n 2", mood: "stress", status: "Mai ki·ªÉm tra To√°n r·ªìi üò≠" },
            { id: 3, name: "B·∫°n b√†n 3", mood: "sad", status: "C·∫ßn ng∆∞·ªùi t√¢m s·ª±..." },
            { id: 4, name: "B·∫°n b√†n 4", mood: "happy", status: "M·ªõi ƒë∆∞·ª£c ƒëi·ªÉm 10!" },
            { id: 5, name: "B·∫°n b√†n 5", mood: "happy", status: "ƒêang r·∫•t ·ªïn!" },
            // ... th√™m random sau
        ];

        let messages = []; 
        let history = JSON.parse(localStorage.getItem('emotionHistory')) || []; 
        let audioCtx, whiteNoiseSource;
        let myChart = null; 

        // --- KH·ªûI CH·∫†Y ---
        window.onload = function() {
            renderClassMap();
            checkDarkMode();
            
            const greeting = "Ch√†o b·∫°n! B·∫°n c·∫ßn t∆∞ v·∫•n g√¨ h√¥m nay? üò∫";
            addMessage(greeting, 'ai');
            document.getElementById('statusText').innerText = "Groq AI Online ‚ö°";
            
            const systemPrompt = `
                B·∫°n l√† EmoMap, m·ªôt nh√† t√¢m l√Ω h·ªçc l·ªói l·∫°c.
                NHI·ªÜM V·ª§ PH√ÇN T√çCH CHUY√äN S√ÇU:
                1. üß¨ **Emotion DNA:** X√°c ƒë·ªãnh "m√£ gen c·∫£m x√∫c" c·ªßa ng∆∞·ªùi d√πng (Nh·∫°y c·∫£m/Ki√™n c∆∞·ªùng/D·ªÖ t·ªïn th∆∞∆°ng).
                2. üß† **Fake Emotion Radar:** Ph√°t hi·ªán s·ª± m√¢u thu·∫´n gi·ªØa l·ªùi n√≥i "M√¨nh ·ªïn" v√† gi·ªçng vƒÉn bu·ªìn b√£.
                3. ‚è≥ **Emotion Forecasting:** D·ª± b√°o: "N·∫øu ti·∫øp t·ª•c suy nghƒ© n√†y, kh·∫£ nƒÉng cao b·∫°n s·∫Ω b·ªã burnout trong 2 ng√†y t·ªõi."
                4. üß© **Cognitive Distortion:** Ch·ªâ ra l·ªói t∆∞ duy (V√≠ d·ª•: "B·∫°n ƒëang t∆∞ duy tr·∫Øng-ƒëen, s·ª± th·∫≠t kh√¥ng t·ªá nh∆∞ v·∫≠y").
                5. ü™û **Emotion Mirror:** "N·∫øu m√¨nh l√† b·∫°n, m√¨nh c≈©ng s·∫Ω c·∫£m th·∫•y b·∫•t l·ª±c."
                6. üõë **Burnout Scanner:** C·∫£nh b√°o n·∫øu th·∫•y d·∫•u hi·ªáu ki·ªát s·ª©c c·∫£m x√∫c.

                QUY T·∫ÆC H√ÄNH X·ª¨:
                - N·∫øu ch·ªâ ch√†o h·ªèi -> Ch√†o l·∫°i th√¢n thi·ªán.
                - N·∫øu NGHE T·ª™ KH√ìA BU·ªíN/STRESS -> Ph√¢n t√≠ch nh·∫π nh√†ng r·ªìi h·ªèi: "C·∫≠u c√≥ mu·ªën nghe nh·∫°c Lofi ƒë·ªÉ th∆∞ gi√£n kh√¥ng?".
                - N·∫øu USER ƒê·ªíNG √ù NGHE NH·∫†C -> CH·ªà TR·∫¢ L·ªúI DUY NH·∫§T C·ª§M T·ª™: "PLAY_SPOTIFY_NOW".
                - Gi·ªçng vƒÉn: ·∫§m √°p, th·∫•u hi·ªÉu, chuy√™n nghi·ªáp nh∆∞ng g·∫ßn g≈©i.
            `;

            messages.push({ role: "system", content: systemPrompt });
            messages.push({ role: "assistant", content: greeting });

            if(!API_KEY || API_KEY.includes("D√ÅN_KEY")) {
                setTimeout(() => alert("‚ö†Ô∏è C·∫¢NH B√ÅO: Ch∆∞a nh·∫≠p API Key Groq! Web s·∫Ω kh√¥ng tr·∫£ l·ªùi ƒë∆∞·ª£c."), 1000);
            }
        };

        // --- CHAT ---
        async function handleChat() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if(!text) return;

            if(SOS_WORDS.some(kw => text.toLowerCase().includes(kw))) {
                document.getElementById('sosOverlay').style.display='flex';
                input.value=''; return;
            }

            addMessage(text, 'user');
            input.value = '';
            
            const typing = document.getElementById('typingIndicator');
            typing.style.display = 'block';
            document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;

            messages.push({ role: "user", content: text });

            try {
                const aiText = await callGroqAPI(messages);
                typing.style.display = 'none';
                messages.push({ role: "assistant", content: aiText });
                processResponse(aiText, text);
            } catch (error) {
                typing.style.display = 'none';
                addMessage("‚ö†Ô∏è L·ªói: " + error.message, 'ai');
            }
        }

        async function callGroqAPI(msgs) {
            const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                body: JSON.stringify({ model: "llama-3.3-70b-versatile", messages: msgs, temperature: 0.7 })
            });
            if (!response.ok) throw new Error((await response.json()).error.message);
            return (await response.json()).choices[0].message.content;
        }

        function processResponse(text, userText) {
            if (text.includes("PLAY_SPOTIFY_NOW")) {
                addMessage("Oki! Nh·∫°c l√™n ngay ƒë√¢y. üé∂", 'ai');
                const t = userText.toLowerCase();
                let link = LINK_LOFI; 
                if (t.includes("vui") || t.includes("tuy·ªát") || t.includes("h·∫°nh ph√∫c")) link = LINK_VUI;
                addMessage(`<iframe style="border-radius:12px; margin-top:10px;" src="${link}" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>`, 'ai');
            } else {
                addMessage(text.replace(/\*\*/g, ''), 'ai');
            }
            
            const t = userText.toLowerCase();
            let score = 5;
            if(t.includes('bu·ªìn')||t.includes('kh√≥c')) { changeTheme('sad'); score=2; }
            else if(t.includes('vui')||t.includes('tuy·ªát')) { changeTheme('happy'); score=10; }
            else if(t.includes('cƒÉng')||t.includes('lo')) { changeTheme('stress'); score=1; }
            saveHistory(userText, score);
        }

        // --- C√ÅC H√ÄM PH·ª§ TR·ª¢ ---
        function addMessage(html, type) {
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerHTML = html;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function openModal(id) {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
            const m = document.getElementById(id);
            if(m) { m.classList.add('active'); if(id === 'statsModal') renderChart(); }
        }

        function closeModal(id) {
            const m = document.getElementById(id);
            if(m) m.classList.remove('active');
        }

        function changeTheme(e) { document.body.className = ''; if(e) document.body.classList.add(`theme-${e}`); checkDarkMode(); }
        
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('kitty_darkMode', isDark);
            document.querySelector('.theme-btn i').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        }
        function checkDarkMode() {
            if(localStorage.getItem('kitty_darkMode') === 'true') { toggleDarkMode(); document.querySelector('.theme-btn i').className = 'fas fa-sun'; }
        }

        function startDictation() {
            if (window.hasOwnProperty('webkitSpeechRecognition')) {
                var recognition = new webkitSpeechRecognition();
                recognition.lang = "vi-VN";
                const btn = document.getElementById('voiceBtn');
                btn.classList.add('listening');
                recognition.start();
                recognition.onresult = function(e) { document.getElementById('userInput').value = e.results[0][0].transcript; recognition.stop(); btn.classList.remove('listening'); };
                recognition.onerror = function(e) { recognition.stop(); btn.classList.remove('listening'); alert("Kh√¥ng nghe r√µ."); };
            } else { alert("D√πng Chrome ƒë·ªÉ n√≥i nh√©."); }
        }

        function saveHistory(text, score) {
            history.push({ time: new Date().toLocaleTimeString(), text: text, score: score });
            if(history.length > 20) history.shift();
            localStorage.setItem('emotionHistory', JSON.stringify(history));
        }

        function renderChart() {
            const ctx = document.getElementById('emotionChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: history.map(h => h.time),
                    datasets: [{ label: 'C·∫£m x√∫c (1-10)', data: history.map(h => h.score), borderColor: '#ff9f43', backgroundColor: 'rgba(255, 159, 67, 0.2)', tension: 0.4, fill: true }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 10 } } }
            });
        }

        // --- MAP LOGIC (NEW) ---
        function renderClassMap() {
            const g = document.getElementById('classMapGrid');
            g.innerHTML = '';
            
            // Render 19 b·∫°n h·ªçc sinh gi·∫£ l·∫≠p
            for(let i=0; i<19; i++) {
                let mood = ['happy','stress','sad'][Math.floor(Math.random()*3)];
                let d = document.createElement('div');
                d.className = `student-seat seat-${mood}`;
                d.innerText = i+1;
                d.onclick = () => showStudentInfo(i+1, mood);
                g.appendChild(d);
            }
            
            // Render b·∫£n th√¢n
            let me = document.createElement('div');
            me.className = 'student-seat seat-me';
            me.innerText = 'Me';
            g.insertBefore(me, g.firstChild);
        }

        function showStudentInfo(id, mood) {
            const popup = document.getElementById('studentPopup');
            const nameEl = document.getElementById('popupName');
            const statusEl = document.getElementById('popupStatus');
            
            popup.classList.add('active');
            nameEl.innerText = `B·∫°n b√†n s·ªë ${id}`;
            
            if(mood === 'happy') statusEl.innerText = "\"ƒêang th·∫•y y√™u ƒë·ªùi! üåª\"";
            else if(mood === 'sad') statusEl.innerText = "\"H∆°i bu·ªìn m·ªôt ch√∫t... üåßÔ∏è\"";
            else statusEl.innerText = "\"√Åp l·ª±c qu√° ƒëi m·∫•t ü§Ø\"";
        }

        function sendLove() {
            // Hi·ªáu ·ª©ng tim bay
            const container = document.querySelector('.map-container');
            for(let i=0; i<5; i++) {
                let heart = document.createElement('div');
                heart.className = 'floating-heart';
                heart.innerHTML = 'üíñ';
                heart.style.left = Math.random() * 80 + 10 + '%';
                heart.style.bottom = '100px';
                document.getElementById('mapModal').appendChild(heart);
                setTimeout(() => heart.remove(), 1000);
            }
            document.getElementById('studentPopup').classList.remove('active');
            alert("ƒê√£ g·ª≠i nƒÉng l∆∞·ª£ng t√≠ch c·ª±c! ‚ö°");
        }

        // --- THERAPY & RESET ---
        function initAudio(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }
        function playWhiteNoise(){ initAudio(); const b=audioCtx.createBuffer(1, audioCtx.sampleRate*2, audioCtx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1; whiteNoiseSource=audioCtx.createBufferSource(); whiteNoiseSource.buffer=b; whiteNoiseSource.loop=true; const g=audioCtx.createGain(); g.gain.value=0.1; whiteNoiseSource.connect(g); g.connect(audioCtx.destination); whiteNoiseSource.start(); }
        function stopWhiteNoise(){ if(whiteNoiseSource){ whiteNoiseSource.stop(); whiteNoiseSource=null; } }
        let resetInt;
        window.activateReset=function(){ document.getElementById('resetOverlay').style.display='flex'; try{playWhiteNoise();}catch(e){} let t=30; resetInt=setInterval(()=>{ t--; document.getElementById('resetCount').innerText=t; if(t<=0) closeReset(); },1000); }
        window.closeReset=function(){ clearInterval(resetInt); document.getElementById('resetOverlay').style.display='none'; stopWhiteNoise(); addMessage("Ch√†o m·ª´ng c·∫≠u quay l·∫°i! üåø", 'ai'); }
        
        window.startExercise=function(t){ 
            closeModal('therapyModal');
            let text = "";
            if(t==='breath') text = "üå¨Ô∏è <b>H√≠t th·ªü 4-7-8:</b><br>1. H√≠t v√†o (4s)<br>2. Gi·ªØ h∆°i (7s)<br>3. Th·ªü ra (8s)<br><i>L·∫∑p l·∫°i 4 l·∫ßn ƒë·ªÉ b√¨nh tƒ©nh l·∫°i.</i>";
            else if(t==='stretch') text = "üôÜ <b>Th∆∞ gi√£n C·ªï Vai:</b><br>1. Nghi√™ng ƒë·∫ßu tr√°i 10s<br>2. Nghi√™ng ƒë·∫ßu ph·∫£i 10s<br>3. Xoay vai ra sau 5 l·∫ßn.";
            else text = "üëÅÔ∏è <b>Grounding 5-4-3-2-1:</b><br>üëÄ T√¨m 5 v·∫≠t b·∫°n th·∫•y<br>‚úã T√¨m 4 v·∫≠t ch·∫°m ƒë∆∞·ª£c<br>üëÇ T√¨m 3 √¢m thanh nghe ƒë∆∞·ª£c...";
            addMessage(text, 'ai'); 
        }

        document.getElementById('userInput').addEventListener("keypress", e=>{if(e.key==="Enter") handleChat()});
    </script>
</body>
</html>


